<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyline Studio | Ultimate AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');

        :root { --accent: #0b63c7; --success: #10b981; --error: #ef4444; --ease: cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        body {
            background: radial-gradient(at top left, #ffffff 0%, #e6f2ff 40%, #cce4ff 100%);
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: 100vh; color: #05294a; margin: 0; overflow-x: hidden;
        }

        /* 3D CARD ENGINE */
        .card-container { perspective: 2000px; width: min(800px, 90vw); height: 450px; position: relative; }
        .card-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.8s var(--ease); transform-style: preserve-3d;
        }
        .card-inner.flipped { transform: rotateY(180deg); }
        .face {
            position: absolute; inset: 0; backface-visibility: hidden;
            border-radius: 40px; padding: 40px; display: flex; flex-direction: column;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 25px 50px -12px rgba(11, 99, 199, 0.15);
        }
        .back { transform: rotateY(180deg); background: #f8fbff; }

        /* UI ELEMENTS */
        .glass-btn {
            background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(255,255,255,0.8);
            backdrop-filter: blur(10px); transition: all 0.3s var(--ease);
        }
        .glass-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(11,99,199,0.1); background: white; }
        
        .mode-switch {
            position: relative; background: #e0eaff; border-radius: 99px; padding: 5px; display: flex; cursor: pointer;
        }
        .slider {
            position: absolute; top: 5px; left: 5px; width: calc(50% - 5px); height: calc(100% - 10px);
            background: white; border-radius: 99px; transition: 0.4s var(--ease);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .hidden-view { display: none !important; opacity: 0; }
        .view-anim { animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* SUMMARY & LOADING */
        .summary-card {
            background: white; border-radius: 16px; padding: 15px; margin-bottom: 10px;
            border-left: 5px solid #ccc; transition: 0.3s;
        }
        .res-correct { border-left-color: var(--success); }
        .res-wrong { border-left-color: var(--error); }

        /* LOAD SPINNER */
        .loader {
            width: 60px; height: 60px; border: 5px solid #FFF; border-bottom-color: transparent;
            border-radius: 50%; display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <nav class="max-w-7xl mx-auto px-8 py-6 flex justify-between items-center z-50 relative">
        <div class="flex items-center gap-3 cursor-pointer hover:scale-105 transition" onclick="showView('library')">
            <div class="w-10 h-10 bg-[#0b63c7] rounded-xl flex items-center justify-center shadow-lg shadow-blue-200">
                <i data-lucide="brain-circuit" class="text-white w-5 h-5"></i>
            </div>
            <span class="font-black text-2xl tracking-tighter text-[#05294a]">Skyline</span>
        </div>
        <div class="flex gap-4">
            <button onclick="window.location.href='homepage.html'" class="glass-btn px-6 py-2 rounded-full text-xs font-bold uppercase tracking-widest text-slate-500">–ù–∞—á–∞–ª–æ</button>
        </div>
    </nav>

    <section id="view-create" class="view-anim flex flex-col items-center pt-5 hidden-view">
        <div class="card-container mb-8">
            <div class="card-inner" id="createCard" onclick="this.classList.toggle('flipped'); playSound('flip')">
                <div class="face front">
                    <div class="flex justify-between w-full mb-4">
                        <span class="text-[10px] font-black text-blue-500 tracking-widest uppercase">–ù–û–í–ê –ö–ê–†–¢–ê</span>
                        <i data-lucide="sparkles" class="text-blue-300 w-5 h-5"></i>
                    </div>
                    <textarea id="q-in" class="text-3xl font-extrabold bg-transparent outline-none resize-none flex-1 placeholder-blue-100/50" placeholder="–ö–∞–∫–≤–∞ –µ —Ç–µ–º–∞—Ç–∞?" onclick="event.stopPropagation()"></textarea>
                    <button onclick="runAI(event)" id="genBtn" class="w-full py-4 bg-[#0b63c7] text-white rounded-2xl font-bold shadow-lg shadow-blue-200 hover:shadow-blue-400 transition-all hover:scale-[1.02]">‚ú® AI –ê–Ω–∞–ª–∏–∑</button>
                </div>
                <div class="face back">
                    <span class="text-[10px] font-black text-green-500 mb-4 tracking-widest uppercase">AI –†–ï–ó–£–õ–¢–ê–¢</span>
                    <textarea id="a-out" class="text-lg font-medium bg-transparent outline-none resize-none flex-1 text-slate-600" onclick="event.stopPropagation()"></textarea>
                    <button onclick="addToQueue(event)" class="w-full py-4 bg-black text-white rounded-2xl font-bold hover:bg-slate-800 transition">–î–æ–±–∞–≤–∏ –≤ –ø–∞–ø–∫–∞</button>
                </div>
            </div>
        </div>

        <div class="w-full max-w-5xl px-6">
            <div class="flex justify-between items-center mb-4">
                <h4 class="font-black text-[10px] uppercase tracking-widest text-slate-400">–ß–∞–∫–∞—â–∏ (<span id="q-count">0</span>)</h4>
                <div class="flex gap-3">
                    <input id="deck-in" type="text" placeholder="–ò–º–µ –Ω–∞ –ø–∞–ø–∫–∞..." class="px-5 py-2 rounded-xl border border-blue-100 outline-none text-sm focus:ring-2 focus:ring-blue-300 transition">
                    <button onclick="saveAll()" id="saveBtn" class="px-6 py-2 bg-blue-600 text-white rounded-xl text-xs font-black uppercase hidden hover:bg-blue-700 transition">–ó–∞–ø–∞–∑–∏</button>
                </div>
            </div>
            <div id="carousel" class="flex gap-4 overflow-x-auto pb-4 scrollbar-hide"></div>
        </div>
    </section>

    <section id="view-library" class="view-anim max-w-6xl mx-auto px-10 pt-5">
        <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-5">
            <div>
                <h1 class="text-5xl font-black tracking-tighter text-[#05294a] mb-2">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
                <p class="text-slate-400 font-medium">–ò–∑–±–µ—Ä–∏ —Ç–µ–º–∞ –∏ –∑–∞–ø–æ—á–Ω–∏ –¥–∞ —É—á–∏—à.</p>
            </div>
            <button onclick="showView('create')" class="glass-btn px-8 py-4 rounded-2xl flex items-center gap-2 font-bold text-blue-600">
                <i data-lucide="plus"></i> –°—ä–∑–¥–∞–π –Ω–æ–≤–∏
            </button>
        </div>
        <div id="deck-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20"></div>
    </section>

    <section id="view-pre-session" class="hidden-view fixed inset-0 z-50 bg-[#e6f2ff]/90 backdrop-blur-xl flex items-center justify-center">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl max-w-md w-full text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-purple-500"></div>
            <h2 class="text-3xl font-black mb-2" id="session-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <p class="text-slate-400 text-sm mb-8">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–π —Å–≤–æ–µ—Ç–æ —É—á–µ–Ω–µ</p>

            <div class="bg-slate-50 p-1 rounded-2xl mb-6 flex relative">
                <div id="mode-slider" class="absolute top-1 left-1 w-[calc(50%-4px)] h-[calc(100%-8px)] bg-white rounded-xl shadow-md transition-all duration-300"></div>
                <button onclick="setMode('standard')" class="flex-1 py-3 text-sm font-bold z-10 relative transition-colors duration-300 text-blue-600" id="btn-std">–ü—Ä–µ–≥–æ–≤–æ—Ä</button>
                <button onclick="setMode('ai')" class="flex-1 py-3 text-sm font-bold z-10 relative transition-colors duration-300 text-slate-400" id="btn-ai">AI –ò–∑–ø–∏—Ç</button>
            </div>

            <div class="flex justify-between items-center mb-8 px-2">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-purple-100 rounded-lg text-purple-600"><i data-lucide="shuffle"></i></div>
                    <span class="font-bold text-sm">–†–∞–∑–±—ä—Ä–∫–≤–∞–Ω–µ</span>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="shuffle-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:bg-purple-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                </label>
            </div>

            <button onclick="launchSession()" class="w-full py-4 bg-[#05294a] text-white rounded-2xl font-bold text-lg hover:scale-[1.02] transition shadow-xl shadow-blue-900/20">üöÄ –ó–ê–ü–û–ß–ù–ò</button>
            <button onclick="showView('library')" class="mt-4 text-xs font-bold text-slate-400 hover:text-slate-600">–û—Ç–∫–∞–∑</button>
        </div>
    </section>

    <div id="view-calculating" class="hidden-view fixed inset-0 bg-[#05294a]/95 z-[150] flex flex-col items-center justify-center text-white backdrop-blur-xl">
        <span class="loader mb-8"></span>
        <h2 class="text-3xl font-black mb-2 tracking-tighter">AI –ê–Ω–∞–ª–∏–∑–∏—Ä–∞</h2>
        <p class="text-blue-200 text-sm font-mono animate-pulse">–û—Ü–µ–Ω—è–≤–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏—Ç–µ...</p>
    </div>

    <div id="view-focus" class="hidden-view fixed inset-0 bg-[#e6f2ff] z-[100] flex flex-col items-center justify-center">
        <div class="absolute top-8 w-full max-w-2xl px-6 flex items-center gap-4">
            <button onclick="endSessionEarly()" class="p-3 bg-white rounded-full text-slate-400 hover:text-red-500 hover:bg-red-50 transition"><i data-lucide="x"></i></button>
            <div class="flex-1 h-3 bg-white rounded-full overflow-hidden shadow-inner">
                <div id="progress-bar" class="h-full bg-[#0b63c7] w-0 transition-all duration-500"></div>
            </div>
            <span id="card-counter" class="font-black text-blue-500 text-sm w-12 text-right">1/10</span>
        </div>

        <div class="card-container" id="session-card-container">
            <div class="card-inner" id="sessionCard">
                <div class="face front flex flex-col items-center justify-center text-center p-10">
                    <span class="text-[10px] uppercase font-black tracking-[0.3em] text-slate-300 mb-6">–í–™–ü–†–û–°</span>
                    <p id="focus-q" class="text-3xl font-extrabold text-[#05294a] leading-tight"></p>
                    <div id="ai-input-area" class="w-full mt-8 hidden">
                        <textarea id="user-answer" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-medium outline-none focus:border-blue-500 focus:bg-white transition" rows="3" placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ—è –æ—Ç–≥–æ–≤–æ—Ä —Ç—É–∫..."></textarea>
                        <button onclick="submitAIAnswer()" class="w-full mt-3 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm hover:bg-blue-700 transition">–ü—Ä–æ–≤–µ—Ä–∏ –º–µ</button>
                    </div>
                </div>
                <div class="face back flex flex-col items-center justify-center text-center p-10 relative overflow-hidden">
                    <div id="std-back-content">
                        <span class="text-[10px] uppercase font-black tracking-[0.3em] text-green-300 mb-6">–û–¢–ì–û–í–û–†</span>
                        <p id="focus-a" class="text-2xl font-medium text-slate-600 leading-snug"></p>
                    </div>
                    <div id="ai-result-content" class="hidden w-full h-full flex flex-col items-center justify-center">
                        <div id="ai-score-badge" class="w-20 h-20 rounded-full flex items-center justify-center text-2xl font-black mb-4 bg-slate-100 border-4 border-slate-200">0%</div>
                        <p id="ai-feedback" class="text-sm text-slate-500 mb-4 line-clamp-3">...</p>
                        <button onclick="nextCard()" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold">–ù–∞–ø—Ä–µ–¥</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="std-controls" class="mt-10 flex gap-6">
            <button onclick="flipCard()" class="px-8 py-4 bg-white rounded-full font-bold shadow-lg shadow-blue-100 text-[#05294a] hover:scale-105 transition">–í–∏–∂ –æ—Ç–≥–æ–≤–æ—Ä</button>
            <button onclick="nextCard()" class="p-4 bg-blue-600 text-white rounded-full shadow-lg shadow-blue-300 hover:scale-110 transition"><i data-lucide="arrow-right"></i></button>
        </div>
    </div>

    <div id="view-summary" class="hidden-view fixed inset-0 z-[200] bg-[#e6f2ff] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl h-[90vh] rounded-[40px] shadow-2xl flex flex-col overflow-hidden relative">
            <div class="p-8 text-center bg-[#05294a] text-white">
                <h2 class="text-4xl font-black mb-1" id="sum-title">–ë—Ä–∞–≤–æ!</h2>
                <p class="text-blue-200 text-sm" id="sum-subtitle">–°–µ—Å–∏—è—Ç–∞ –ø—Ä–∏–∫–ª—é—á–∏</p>
                <div id="sum-score-container" class="mt-6 hidden scale-0 transition-transform duration-500">
                    <div class="w-24 h-24 rounded-full border-8 border-white/20 mx-auto flex items-center justify-center text-3xl font-black" id="final-score">0%</div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-8 bg-slate-50" id="summary-list"></div>
            <div class="p-6 bg-white border-t border-slate-100 flex gap-4">
                <button onclick="showView('library')" class="flex-1 py-4 text-slate-500 font-bold hover:bg-slate-50 rounded-2xl">–ö—ä–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞</button>
                <button onclick="restartSession()" class="flex-1 py-4 bg-[#0b63c7] text-white font-bold rounded-2xl shadow-lg shadow-blue-200">–£—á–∏ –æ—Ç–Ω–æ–≤–æ</button>
            </div>
            
            <div id="ai-tutor-overlay" class="absolute inset-0 bg-white/95 backdrop-blur-md z-50 hidden flex-col p-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-black text-2xl text-purple-600"><i data-lucide="sparkles" class="inline mr-2"></i>AI Tutor</h3>
                    <button onclick="closeTutor()" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x"></i></button>
                </div>
                <div id="tutor-content" class="text-lg text-slate-700 leading-relaxed font-medium"></div>
            </div>
        </div>
    </div>

    <script>
        const S_URL = "https://zfqpfhtbpfdudbpqzbbg.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmcXBmaHRicGZkdWRicHF6YmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyOTQ5NzQsImV4cCI6MjA4Mzg3MDk3NH0.QnmNeFn9LX9ZIc-bINH_4DNKFeJj9LCYU7QF5ZwfaDE";
        const sb = window.supabase.createClient(S_URL, S_KEY);
        const WORKER = "https://curly-mountain-4c28.boy05geo.workers.dev"; 

        // --- SOUND ENGINE (FIXED) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function ensureAudio() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            ensureAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if(type === 'click') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.stop(now + 0.1);
            } else if(type === 'flip') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2); gain.gain.linearRampToValueAtTime(0.01, now + 0.2); osc.stop(now + 0.2);
            } else if(type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(440, now); osc.frequency.linearRampToValueAtTime(880, now + 0.1); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5); osc.stop(now + 0.5);
            } else if(type === 'error') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.3); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3); osc.stop(now + 0.3);
            }
            osc.start(now);
        }

        // --- STATE ---
        let queue = [];
        let sessionCards = [];
        let currentIdx = 0;
        let sessionMode = 'standard';
        let sessionResults = [];

        function showView(id) {
            document.querySelectorAll('section, .hidden-view').forEach(el => {
                if(!el.id.includes('view-' + id)) el.classList.add('hidden-view');
            });
            const target = document.getElementById('view-' + id);
            target.classList.remove('hidden-view');
            if(id === 'library') loadDecks();
        }

        // --- CREATE & LIBRARY (Standard) ---
        async function runAI(e) {
            e.stopPropagation();
            const q = document.getElementById('q-in').value;
            if(!q) return;
            document.getElementById('genBtn').innerText = "üß† –ú–∏—Å–ª—è...";
            try {
                const res = await fetch(WORKER, { method: 'POST', body: JSON.stringify({ prompt: q }) });
                const data = await res.json();
                document.getElementById('a-out').value = data.answer;
                document.getElementById('createCard').classList.add('flipped');
                playSound('success');
            } catch(err) { alert("AI –ì—Ä–µ—à–∫–∞"); }
            document.getElementById('genBtn').innerText = "‚ú® AI –ê–Ω–∞–ª–∏–∑";
        }

        function addToQueue(e) {
            e.stopPropagation();
            const f = document.getElementById('q-in').value; const b = document.getElementById('a-out').value;
            if(!f || !b) return;
            queue.push({front:f, back:b}); renderQueue();
            document.getElementById('createCard').classList.remove('flipped');
            document.getElementById('q-in').value=''; document.getElementById('a-out').value='';
            playSound('click');
        }

        function renderQueue() {
            const c = document.getElementById('carousel');
            document.getElementById('q-count').innerText = queue.length;
            document.getElementById('saveBtn').classList.toggle('hidden', queue.length === 0);
            c.innerHTML = queue.map((x,i) => `
                <div class="min-w-[160px] h-[100px] bg-white rounded-xl p-3 border shadow-sm relative group shrink-0">
                    <button onclick="queue.splice(${i},1); renderQueue()" class="absolute top-1 right-1 text-red-400 opacity-0 group-hover:opacity-100"><i data-lucide="x-circle" class="w-4 h-4"></i></button>
                    <p class="text-[10px] font-bold text-blue-400">#${i+1}</p>
                    <p class="text-xs font-bold line-clamp-3">${x.front}</p>
                </div>`).join('');
            lucide.createIcons();
        }

        async function saveAll() {
            const dName = document.getElementById('deck-in').value.trim() || "–û–±—â–∏";
            let { data: deck } = await sb.from('decks').select('id').eq('name', dName).maybeSingle();
            if(!deck) { const { data: nD } = await sb.from('decks').insert({name: dName}).select().single(); deck = nD; }
            await sb.from('flashcards').insert(queue.map(x => ({front:x.front, back:x.back, deck_id:deck.id})));
            queue = []; renderQueue(); showView('library');
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }

        async function loadDecks() {
            const { data } = await sb.from('decks').select('*');
            document.getElementById('deck-grid').innerHTML = data.map(d => `
                <div onclick="openDeckSetup(${d.id}, '${d.name}')" class="bg-white p-8 rounded-[32px] border border-blue-50 hover:shadow-xl hover:translate-y-[-5px] transition cursor-pointer group">
                    <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-blue-600 group-hover:text-white transition"><i data-lucide="folder-open"></i></div>
                    <h3 class="text-xl font-black text-[#05294a]">${d.name}</h3>
                </div>`).join('');
            lucide.createIcons();
        }

        let selectedDeckId = null;
        function openDeckSetup(id, name) {
            selectedDeckId = id; document.getElementById('session-title').innerText = name;
            showView('pre-session');
        }

        // --- SESSION LOGIC ---
        function setMode(m) {
            sessionMode = m; playSound('click');
            const slider = document.getElementById('mode-slider');
            if(m === 'standard') { slider.style.left = '5px'; document.getElementById('btn-std').classList.replace('text-slate-400', 'text-blue-600'); document.getElementById('btn-ai').classList.replace('text-blue-600', 'text-slate-400'); }
            else { slider.style.left = '50%'; document.getElementById('btn-std').classList.replace('text-blue-600', 'text-slate-400'); document.getElementById('btn-ai').classList.replace('text-slate-400', 'text-blue-600'); }
        }

        async function launchSession() {
            ensureAudio(); // Activate Audio Context
            const { data } = await sb.from('flashcards').select('*').eq('deck_id', selectedDeckId);
            if(!data || data.length === 0) { alert("–ü–∞–ø–∫–∞—Ç–∞ –µ –ø—Ä–∞–∑–Ω–∞!"); return; }
            
            sessionCards = [...data];
            if(document.getElementById('shuffle-toggle').checked) sessionCards.sort(() => Math.random() - 0.5);
            
            currentIdx = 0;
            sessionResults = [];
            
            // UI Toggle
            document.getElementById('std-controls').classList.toggle('hidden', sessionMode === 'ai');
            document.getElementById('ai-input-area').classList.toggle('hidden', sessionMode !== 'ai');
            document.getElementById('std-back-content').classList.toggle('hidden', sessionMode === 'ai');
            document.getElementById('ai-result-content').classList.toggle('hidden', sessionMode !== 'ai');

            showView('focus');
            renderSessionCard();
        }

        function renderSessionCard() {
            const card = sessionCards[currentIdx];
            document.getElementById('focus-q').innerText = card.front;
            document.getElementById('focus-a').innerText = card.back;
            document.getElementById('user-answer').value = '';
            document.getElementById('sessionCard').classList.remove('flipped');
            
            const pct = ((currentIdx) / sessionCards.length) * 100;
            document.getElementById('progress-bar').style.width = pct + '%';
            document.getElementById('card-counter').innerText = `${currentIdx + 1}/${sessionCards.length}`;
        }

        function flipCard() {
            document.getElementById('sessionCard').classList.add('flipped');
            playSound('flip');
        }

        async function submitAIAnswer() {
            const uAns = document.getElementById('user-answer').value;
            if(!uAns) return;

            const card = sessionCards[currentIdx];
            const btn = document.querySelector('#ai-input-area button');
            btn.innerText = "–û—Ü–µ–Ω—è–≤–∞–Ω–µ...";
            
            const prompt = `Act as a teacher. Correct: "${card.back}". Student: "${uAns}". Rate 0-100 on meaning match. Return JSON: {"score": number, "feedback": "bg text"}`;
            
            try {
                const res = await fetch(WORKER, { method: 'POST', body: JSON.stringify({ prompt }) });
                const aiData = await res.json();
                
                let result = { score: 0, feedback: aiData.answer };
                try { const m = aiData.answer.match(/\{[\s\S]*\}/); if(m) result = JSON.parse(m[0]); } catch(e){}

                sessionResults.push({
                    card: card, userAns: uAns, score: result.score, feedback: result.feedback, correct: result.score > 60
                });

                document.getElementById('ai-score-badge').innerText = result.score + '%';
                document.getElementById('ai-score-badge').className = `w-20 h-20 rounded-full flex items-center justify-center text-2xl font-black mb-4 border-4 ${result.score > 60 ? 'bg-green-50 border-green-500 text-green-600' : 'bg-red-50 border-red-500 text-red-600'}`;
                document.getElementById('ai-feedback').innerText = result.feedback;
                
                if(result.score > 60) playSound('success'); else playSound('error');

            } catch(err) {
                console.error(err);
                sessionResults.push({ card, userAns: uAns, score: 0, feedback: "Error", correct: false });
            }
            btn.innerText = "–ü—Ä–æ–≤–µ—Ä–∏ –º–µ";
            flipCard();
        }

        function nextCard() {
            if(currentIdx < sessionCards.length - 1) {
                currentIdx++;
                renderSessionCard();
            } else {
                finishSession();
            }
        }

        function finishSession() {
            if(sessionMode === 'ai') {
                showView('calculating');
                // Fake delay for dramatic effect
                setTimeout(() => {
                    renderSummary();
                }, 3000);
            } else {
                renderSummary();
            }
        }

        function renderSummary() {
            showView('summary');
            const list = document.getElementById('summary-list');
            const scContainer = document.getElementById('sum-score-container');
            const scoreEl = document.getElementById('final-score');
            
            playSound('success');
            confetti({ particleCount: 200, spread: 120, origin: { y: 0.6 } });

            if(sessionMode === 'standard') {
                document.getElementById('sum-title').innerText = "–ü—Ä–µ–≥–æ–≤–æ—Ä—ä—Ç –ø—Ä–∏–∫–ª—é—á–∏!";
                document.getElementById('sum-subtitle').innerText = `–ü—Ä–µ–≥–ª–µ–¥–∞—Ö—Ç–µ ${sessionCards.length} –∫–∞—Ä—Ç–∏.`;
                scContainer.classList.add('hidden');
                list.innerHTML = `<div class="text-center py-10 opacity-50">–û–ø–∏—Ç–∞–π—Ç–µ AI —Ä–µ–∂–∏–º –∑–∞ –¥–µ—Ç–∞–π–ª–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.</div>`;
            } else {
                // AI REPORT
                const avg = Math.round(sessionResults.reduce((a,b) => a + b.score, 0) / sessionResults.length) || 0;
                
                document.getElementById('sum-title').innerText = avg >= 80 ? "–û—Ç–ª–∏—á–Ω–∞ —Ä–∞–±–æ—Ç–∞!" : "–î–æ–±—Ä–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞";
                document.getElementById('sum-subtitle').innerText = "–ï—Ç–æ —Ç–≤–æ—è—Ç AI –∞–Ω–∞–ª–∏–∑";
                
                scContainer.classList.remove('hidden');
                setTimeout(() => scContainer.classList.remove('scale-0'), 100);
                
                scoreEl.innerText = avg + '%';
                scoreEl.className = `w-24 h-24 rounded-full border-8 mx-auto flex items-center justify-center text-3xl font-black ${avg >= 60 ? 'border-green-400 text-green-600' : 'border-red-400 text-red-600'}`;

                list.innerHTML = sessionResults.map((r, i) => `
                    <div class="summary-card ${r.correct ? 'res-correct' : 'res-wrong'}">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-xs uppercase text-slate-400">–ö–∞—Ä—Ç–∞ ${i+1}</span>
                            <span class="font-black ${r.correct ? 'text-green-500':'text-red-500'}">${r.score}%</span>
                        </div>
                        <p class="font-bold text-[#05294a] mb-1">${r.card.front}</p>
                        <p class="text-sm text-slate-500 mb-2">–¢–≤–æ—è—Ç –æ—Ç–≥–æ–≤–æ—Ä: "${r.userAns}"</p>
                        ${!r.correct ? `<button onclick="openTutor('${r.feedback.replace(/'/g, "\\'")}')" class="text-xs bg-purple-100 text-purple-600 px-3 py-1 rounded-full font-bold flex items-center gap-1 hover:bg-purple-200 transition"><i data-lucide="sparkles" class="w-3 h-3"></i> AI –û–±—è—Å–Ω–µ–Ω–∏–µ</button>` : ''}
                    </div>
                `).join('');
                lucide.createIcons();
            }
        }

        function openTutor(text) {
            document.getElementById('tutor-content').innerText = text;
            const ov = document.getElementById('ai-tutor-overlay');
            ov.classList.remove('hidden'); ov.classList.add('flex');
        }
        function closeTutor() {
            const ov = document.getElementById('ai-tutor-overlay');
            ov.classList.add('hidden'); ov.classList.remove('flex');
        }
        function restartSession() { launchSession(); }
        function endSessionEarly() { if(confirm("–ü—Ä–µ–∫—ä—Å–≤–∞–Ω–µ?")) showView('library'); }

        window.onload = () => { lucide.createIcons(); loadDecks(); };
    </script>
</body>
</html>
