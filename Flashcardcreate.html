<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyline Studio | Zen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');

        :root { --ease: cubic-bezier(0.4, 0, 0.2, 1); }
        body {
            background: radial-gradient(at top left, #ffffff 0%, #f5f8ff 100%);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #1e293b;
            overflow-x: hidden;
        }

        /* Анимации */
        .fade-in { animation: fadeIn 0.5s var(--ease) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Картата */
        .card-container { perspective: 2000px; width: 850px; height: 500px; }
        .card-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-style: preserve-3d; cursor: pointer;
        }
        .card-inner.flipped { transform: rotateY(180deg); }
        .face {
            position: absolute; inset: 0; backface-visibility: hidden;
            border-radius: 48px; padding: 60px; display: flex; flex-direction: column;
            background: white; border: 1px solid rgba(0,0,0,0.03);
            box-shadow: 0 40px 80px -20px rgba(0,0,0,0.05);
        }
        .back { transform: rotateY(180deg); background: #fcfdfe; }

        /* Focus Mode */
        .focus-overlay {
            position: fixed; inset: 0; background: white; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .glass-btn {
            background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
            border: 1px solid rgba(0,0,0,0.05); transition: all 0.3s var(--ease);
        }
        .glass-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }

        .hidden-view { display: none !important; }
    </style>
</head>
<body>

    <nav class="max-w-7xl mx-auto px-10 py-8 flex justify-between items-center relative z-50">
        <div class="flex items-center gap-3 cursor-pointer" onclick="showView('create')">
            <div class="w-8 h-8 bg-blue-600 rounded-xl"></div>
            <span class="font-black text-xl tracking-tighter">Skyline</span>
        </div>
        <div class="flex items-center gap-6">
            <button onclick="showView('library')" class="text-sm font-bold text-slate-400 hover:text-black transition" data-bg="Библиотеки" data-en="Library">Библиотеки</button>
            <button onclick="toggleLang()" class="w-10 h-10 glass-btn rounded-full text-[10px] font-black" id="langBtn">BG</button>
        </div>
    </nav>

    <section id="view-create" class="fade-in flex flex-col items-center pt-10">
        <div class="card-container">
            <div class="card-inner" id="mainCard">
                <div class="face front">
                    <span class="text-[10px] font-black uppercase tracking-[0.4em] text-blue-500 mb-10" data-bg="НОВА ФЛАШКАРТА" data-en="NEW FLASHCARD">НОВА ФЛАШКАРТА</span>
                    <textarea id="q-in" class="text-5xl font-extrabold bg-transparent outline-none resize-none flex-1 placeholder-slate-200" placeholder="Type topic..."></textarea>
                    <button onclick="generateAI()" id="genBtn" class="w-full py-6 bg-black text-white rounded-3xl font-bold text-lg hover:scale-[1.01] transition active:scale-95">Генерирай</button>
                </div>
                <div class="face back">
                    <span class="text-[10px] font-black uppercase tracking-[0.4em] text-green-500 mb-10">AI ANALYSIS</span>
                    <textarea id="a-out" class="text-2xl font-semibold bg-transparent outline-none resize-none flex-1 text-slate-600"></textarea>
                    <div class="flex gap-4">
                        <input id="deck-in" type="text" placeholder="Библиотека (или остави празно)" class="flex-1 px-6 py-4 bg-white border border-slate-100 rounded-2xl outline-none focus:border-blue-400 transition">
                        <button onclick="saveCard()" class="px-10 py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-100">Запази</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="view-library" class="hidden-view fade-in max-w-6xl mx-auto px-10 pt-10">
        <h2 class="text-5xl font-black tracking-tighter mb-12" data-bg="Твоите Библиотеки" data-en="Your Libraries">Твоите Библиотеки</h2>
        <div id="deck-list" class="grid grid-cols-3 gap-8"></div>
    </section>

    <section id="view-detail" class="hidden-view fade-in max-w-6xl mx-auto px-10 pt-10">
        <div class="flex justify-between items-center mb-12">
            <button onclick="showView('library')" class="p-4 glass-btn rounded-full"><i data-lucide="arrow-left"></i></button>
            <h2 id="detail-title" class="text-3xl font-black tracking-tighter"></h2>
            <button onclick="startFocus()" class="px-8 py-4 bg-black text-white rounded-full text-xs font-black tracking-widest uppercase">Focus Mode</button>
        </div>
        <div id="card-list" class="grid grid-cols-1 gap-4"></div>
    </section>

    <div id="view-focus" class="focus-overlay hidden-view">
        <button onclick="showView('detail')" class="fixed top-10 left-10 p-4 glass-btn rounded-full"><i data-lucide="x"></i></button>
        <h2 id="focus-title" class="fixed top-12 font-black text-sm uppercase tracking-[0.5em] text-slate-300">TITLE</h2>
        
        <div class="card-container !h-[550px]" onclick="document.getElementById('focusCard').classList.toggle('flipped')">
            <div class="card-inner" id="focusCard">
                <div class="face front flex items-center justify-center text-center">
                    <p id="focus-q" class="text-5xl font-extrabold"></p>
                </div>
                <div class="face back flex items-center justify-center text-center">
                    <p id="focus-a" class="text-3xl font-medium text-slate-500"></p>
                </div>
            </div>
        </div>
        <div class="fixed bottom-12 flex gap-10">
            <button onclick="prevCard()" class="p-6 glass-btn rounded-full"><i data-lucide="chevron-left"></i></button>
            <button onclick="nextCard()" class="p-6 glass-btn rounded-full"><i data-lucide="chevron-right"></i></button>
        </div>
    </div>

    <script>
        const S_URL = "https://zfqpfhtbpfdudbpqzbbg.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmcXBmaHRicGZkdWRicHF6YmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyOTQ5NzQsImV4cCI6MjA4Mzg3MDk3NH0.QnmNeFn9LX9ZIc-bINH_4DNKFeJj9LCYU7QF5ZwfaDE";
        const sb = window.supabase.createClient(S_URL, S_KEY);
        const WORKER = "https://curly-mountain-4c28.boy05geo.workers.dev";

        let currentDeck = null;
        let cards = [];
        let index = 0;
        let lang = 'BG';

        lucide.createIcons();

        function showView(view) {
            document.querySelectorAll('section, .focus-overlay').forEach(el => el.classList.add('hidden-view'));
            document.getElementById(`view-${view}`).classList.remove('hidden-view');
            if(view === 'library') loadDecks();
        }

        function toggleLang() {
            lang = lang === 'BG' ? 'EN' : 'BG';
            document.getElementById('langBtn').innerText = lang;
            document.querySelectorAll('[data-bg]').forEach(el => {
                el.innerText = lang === 'BG' ? el.getAttribute('data-bg') : el.getAttribute('data-en');
            });
        }

        async function generateAI() {
            const q = document.getElementById('q-in').value;
            if(!q) return;
            document.getElementById('genBtn').innerText = "...";
            const res = await fetch(WORKER, { method: 'POST', body: JSON.stringify({ prompt: q }) });
            const data = await res.json();
            document.getElementById('a-out').value = data.answer;
            document.getElementById('mainCard').classList.add('flipped');
            document.getElementById('genBtn').innerText = "Готово";
        }

        async function saveCard() {
            const q = document.getElementById('q-in').value;
            const a = document.getElementById('a-out').value;
            let dName = document.getElementById('deck-in').value.trim();

            if(!dName) {
                const res = await fetch(WORKER, { method: 'POST', body: JSON.stringify({ prompt: `Дай 1 дума заглавие за: ${q}` }) });
                const data = await res.json();
                dName = data.answer.replace(/[".]/g, '');
            }

            let { data: deck } = await sb.from('decks').select('id').eq('name', dName).maybeSingle();
            if(!deck) {
                const { data: nD } = await sb.from('decks').insert({ name: dName }).select().single();
                deck = nD;
            }

            await sb.from('flashcards').insert({ front: q, back: a, deck_id: deck.id });
            alert("Запазено!");
            location.reload();
        }

        async function loadDecks() {
            const { data } = await sb.from('decks').select('*');
            const list = document.getElementById('deck-list');
            list.innerHTML = data.map(d => `
                <div onclick="openDeck(${d.id}, '${d.name}')" class="bg-white p-8 rounded-[40px] border border-slate-50 cursor-pointer hover:translate-y-[-5px] transition shadow-sm">
                    <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center mb-6"><i data-lucide="folder" class="text-blue-500"></i></div>
                    <h3 class="text-xl font-extrabold">${d.name}</h3>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function openDeck(id, name) {
            currentDeck = id;
            document.getElementById('detail-title').innerText = name;
            showView('detail');
            const { data } = await sb.from('flashcards').select('*').eq('deck_id', id);
            cards = data;
            renderCards();
        }

        function renderCards() {
            const list = document.getElementById('card-list');
            list.innerHTML = cards.map(c => `
                <div class="bg-white p-6 rounded-3xl flex justify-between items-center group">
                    <p class="font-bold">${c.front}</p>
                    <button onclick="deleteCard(${c.id})" class="opacity-0 group-hover:opacity-100 p-3 text-red-400 hover:bg-red-50 rounded-full transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function deleteCard(id) {
            if(!confirm("Изтриване?")) return;
            await sb.from('flashcards').delete().eq('id', id);
            cards = cards.filter(c => c.id !== id);
            renderCards();
        }

        function startFocus() {
            if(!cards.length) return;
            index = 0;
            showView('focus');
            document.getElementById('focus-title').innerText = document.getElementById('detail-title').innerText;
            updateFocus();
        }

        function updateFocus() {
            document.getElementById('focus-q').innerText = cards[index].front;
            document.getElementById('focus-a').innerText = cards[index].back;
            document.getElementById('focusCard').classList.remove('flipped');
        }

        function nextCard() { index = (index + 1) % cards.length; updateFocus(); }
        function prevCard() { index = (index - 1 + cards.length) % cards.length; updateFocus(); }
    </script>
</body>
</html>
