<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyline OS | Flashcard Studio</title>
    
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-gray: #F2F2F7;
            --ease-apple: cubic-bezier(0.25, 1, 0.5, 1);
            --accent: #0b63c7;
            --accent-2: #009fe6;
            --grad-start: rgba(32, 102, 255, 0.72);
            --grad-end: rgba(255, 255, 255, 0.5);
        }
        
        body {
            background:
                linear-gradient(180deg, var(--grad-start), var(--grad-end));
            font-family: 'Inter', sans-serif;
            color: #1D1D1F;
            -webkit-font-smoothing: antialiased;
        }

        .skyline-logo {
            font-family: 'Montserrat', Arial, sans-serif;
            font-weight: 700;
            font-size: 24px;
            letter-spacing: -1px;
            color: #05294a;
            user-select: none;
            cursor: pointer;
        }

        /* 3D CAPSULE ELEMENT */
        .capsule-container {
            width: 140px;
            height: 260px;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            border-radius: 9999px;
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: 
                20px 20px 60px #bebebe, 
                -20px -20px 60px #ffffff,
                inset 0 0 20px rgba(0, 122, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .capsule-container:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                25px 25px 70px #bebebe, 
                -25px -25px 70px #ffffff,
                inset 0 0 30px rgba(0, 122, 255, 0.2);
        }

        .capsule-container:active {
            transform: scale(0.95);
        }

        .capsule-content {
            text-align: center;
            color: #007AFF;
            pointer-events: none; /* Кликовете минават към капсулата */
        }

        .capsule-shine {
            position: absolute;
            top: 0; left: 0; right: 0; height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0));
            border-radius: 9999px 9999px 0 0;
            pointer-events: none;
        }

        /* UI & CARDS */
        .ios-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .ios-btn { transition: all 0.2s var(--ease-apple); }
        .ios-btn:active { transform: scale(0.96); opacity: 0.8; }

        .hidden-view { display: none !important; }
        .fade-in { animation: fadeIn 0.4s var(--ease-apple) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* 3D FLIP */
        .card-container { perspective: 2000px; width: min(700px, 90vw); height: 420px; position: relative; }
        .card-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.6s var(--ease-apple); transform-style: preserve-3d;
        }
        .card-inner.flipped { transform: rotateY(180deg); }
        .face {
            position: absolute; inset: 0; backface-visibility: hidden;
            border-radius: 32px; padding: 40px; display: flex; flex-direction: column;
            background: white; border: 1px solid #E5E5EA;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1);
        }
        .back { transform: rotateY(180deg); background: #FAFAFA; }
        
        .apple-loader {
            width: 60px; height: 60px; background: var(--accent);
            border-radius: 50%;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring { 
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(0, 122, 255, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(0, 122, 255, 0); }
        }

        /* Dark mode variant similar to homepage */
        body.dark-mode {
            color: #e5e7eb;
            background:
                linear-gradient(180deg, rgba(15,23,42,0.96), rgba(15,23,42,0.92));
        }
        body.dark-mode nav { background: rgba(15,23,42,0.88); border-color: rgba(148,163,184,0.4); }
        body.dark-mode .ios-card { background: rgba(15,23,42,0.9); border-color: rgba(148,163,184,0.35); box-shadow: 0 18px 40px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-[#F5F5F7] min-h-screen pb-20">

    <nav class="sticky top-0 z-40 bg-white/70 backdrop-blur-md border-b border-gray-200">
        <div class="max-w-6xl mx-auto px-6 h-16 grid grid-cols-3 items-center">
            
            <div class="flex gap-2">
                <button onclick="location.href='homepage (3).html'" class="w-10 h-10 flex items-center justify-center text-gray-500 hover:text-black transition rounded-full hover:bg-black/5" title="Отиди към начална страница">
                    <i data-lucide="home" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="flex justify-center" onclick="goHome()">
                <div class="skyline-logo">StudySpace</div>
            </div>

            <div class="flex justify-end">
                <button onclick="showView('create')" class="bg-[#007AFF] text-white px-5 py-2 rounded-full text-sm font-medium hover:bg-blue-600 transition ios-btn shadow-md shadow-blue-500/20">
                    + Нова
                </button>
            </div>
        </div>
    </nav>

    <section id="view-library" class="max-w-6xl mx-auto px-6 py-10 fade-in">
        <div class="flex flex-col items-center mb-10 text-center">
            <h1 class="text-3xl font-bold tracking-tight text-[#1D1D1F] mb-2">Твоите Библиотеки</h1>
            <p class="text-gray-500 max-w-md">Управление на знанията и картите.</p>
        </div>
        <div id="deck-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    </section>

    <!-- Time capsule removed from this page -->

    <section id="view-create" class="hidden-view pt-10 flex flex-col items-center">
        <div class="card-container mb-6">
            <div class="card-inner" id="createCard">
                <div class="face front">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Тема</span>
                        <button onclick="goHome()" class="text-gray-400 hover:text-black"><i data-lucide="x"></i></button>
                    </div>
                    <textarea id="q-in" class="flex-1 text-2xl font-bold bg-transparent outline-none resize-none placeholder-gray-300" placeholder="Въведи тема..."></textarea>
                    <button onclick="runAI()" id="genBtn" class="w-full py-3.5 bg-black text-white rounded-xl font-medium ios-btn flex items-center justify-center gap-2">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> Авто-генериране
                    </button>
                </div>
                <div class="face back">
                    <span class="text-xs font-bold text-green-600 uppercase tracking-widest mb-4">AI Резултат</span>
                    <textarea id="a-out" class="flex-1 text-lg bg-transparent outline-none resize-none text-gray-700"></textarea>
                    <div class="flex gap-2">
                        <button onclick="flipBack()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-medium ios-btn">Отказ</button>
                        <button onclick="addToQueue()" class="flex-[2] py-3 bg-[#007AFF] text-white rounded-xl font-medium ios-btn">Запази</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="w-full max-w-2xl bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex items-center gap-4">
            <span class="text-xs font-bold text-gray-400 uppercase w-20">Чакащи: <span id="q-count">0</span></span>
            <div id="carousel" class="flex-1 flex gap-2 overflow-x-auto h-12 items-center"></div>
            <div class="flex gap-2">
                <input id="deck-in" class="bg-gray-50 border-none rounded-lg px-3 py-2 text-sm outline-none w-32 focus:ring-1 ring-blue-500" placeholder="Име на папка">
                <button onclick="saveAll()" class="w-10 h-10 bg-green-500 text-white rounded-lg flex items-center justify-center ios-btn"><i data-lucide="save"></i></button>
            </div>
        </div>
    </section>

    <div id="modal-settings" class="hidden-view fixed inset-0 z-50 flex items-center justify-center bg-black/20 backdrop-blur-sm fade-in" onclick="if(event.target === this) closeModal()">
        <div class="bg-white/90 backdrop-blur-xl w-full max-w-sm p-6 rounded-[32px] shadow-2xl border border-white/50 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold" id="modal-title">Настройки</h2>
                <button onclick="closeModal()" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-300"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="bg-gray-100 p-1 rounded-xl mb-6 flex relative">
                <div id="toggle-bg" class="absolute top-1 left-1 w-[calc(50%-4px)] h-[calc(100%-8px)] bg-white rounded-lg shadow-sm transition-all duration-300 ease-[cubic-bezier(0.25,1,0.5,1)]"></div>
                <button onclick="toggleMode('standard')" class="flex-1 py-2 text-sm font-semibold z-10 relative transition-colors duration-300 text-black" id="t-std">Преговор</button>
                <button onclick="toggleMode('ai')" class="flex-1 py-2 text-sm font-semibold z-10 relative transition-colors duration-300 text-gray-400" id="t-ai">AI Изпит</button>
            </div>
            <div class="flex justify-between items-center mb-8 px-1">
                <span class="font-medium text-gray-700">Разбъркване</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="shuffle-check" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:bg-green-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all after:shadow-sm"></div>
                </label>
            </div>
            <div class="mt-1 rounded-2xl bg-gray-50 border border-gray-200 p-3">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-widest mb-2">Управление на папката</p>
                <div class="flex gap-2">
                    <button onclick="openRenameDeck()" class="flex-1 py-2.5 bg-white text-gray-800 rounded-xl border border-gray-200 text-sm font-medium hover:bg-gray-50 ios-btn">Преименувай</button>
                    <button onclick="confirmDeleteDeck()" class="flex-1 py-2.5 bg-red-50 text-red-600 rounded-xl border border-red-100 text-sm font-semibold hover:bg-red-100 ios-btn">Изтрий</button>
                </div>
            </div>

            <button onclick="startSession()" class="mt-4 w-full py-4 bg-[#007AFF] text-white rounded-2xl font-bold text-lg hover:bg-blue-600 ios-btn shadow-lg shadow-blue-500/30">Започни</button>
        </div>
    </div>

    <!-- Rename deck modal -->
    <div id="rename-modal" class="hidden-view fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm" onclick="if(event.target === this) closeRenameModal()">
        <div class="bg-white/95 backdrop-blur-xl w-full max-w-sm p-6 rounded-[32px] shadow-2xl border border-white/60">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Преименуване</h3>
                <button onclick="closeRenameModal()" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-300"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <p class="text-sm text-gray-500 mb-4">Въведи ново име за избраната папка.</p>
            <input id="rename-input" class="w-full px-3 py-2.5 rounded-xl border border-gray-200 bg-gray-50 text-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ново име">
            <div class="flex gap-2 mt-5">
                <button onclick="closeRenameModal()" class="flex-1 py-2.5 rounded-xl bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200 ios-btn">Отказ</button>
                <button onclick="applyRenameDeck()" class="flex-1 py-2.5 rounded-xl bg-[#007AFF] text-white text-sm font-semibold hover:bg-blue-600 ios-btn">Запази</button>
            </div>
        </div>
    </div>

    <!-- Delete deck confirmation modal -->
    <div id="delete-modal" class="hidden-view fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm" onclick="if(event.target === this) closeDeleteModal()">
        <div class="bg-white/95 backdrop-blur-xl w-full max-w-sm p-6 rounded-[32px] shadow-2xl border border-white/60">
            <h3 class="text-lg font-bold text-gray-900 mb-2">Изтриване на папка</h3>
            <p class="text-sm text-gray-600 mb-4">Сигурни ли сте, че искате да изтриете „<span id="delete-name" class="font-semibold"></span>“? Всички карти в нея ще бъдат премахнати.</p>
            <div class="flex gap-2 mt-2">
                <button onclick="closeDeleteModal()" class="flex-1 py-2.5 rounded-xl bg-gray-100 text-gray-700 text-sm font-medium hover:bg-gray-200 ios-btn">Отказ</button>
                <button onclick="performDeleteDeck()" class="flex-1 py-2.5 rounded-xl bg-red-500 text-white text-sm font-semibold hover:bg-red-600 ios-btn">Изтрий</button>
            </div>
        </div>
    </div>

    <section id="view-focus" class="hidden-view fixed inset-0 z-40 bg-[#F5F5F7] flex flex-col items-center justify-center">
        <div class="absolute top-0 w-full p-6 flex items-center justify-between max-w-4xl">
            <button onclick="goHome()" class="text-gray-400 hover:text-red-500 transition font-medium">Отказ</button>
            <div class="flex flex-col items-center">
                <span class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">ПРОГРЕС</span>
                <div class="w-32 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                    <div id="progress-fill" class="h-full bg-[#007AFF] w-0 transition-all duration-500"></div>
                </div>
            </div>
            <span id="counter" class="text-sm font-bold text-gray-500 font-mono">1/10</span>
        </div>
        <div class="card-container" id="session-card-wrapper">
            <div class="card-inner" id="sessionCard">
                <div class="face front items-center justify-center text-center">
                    <p id="s-front" class="text-3xl font-bold text-gray-800"></p>
                    <div id="ai-input-box" class="w-full mt-6 hidden">
                        <textarea id="ai-user-ans" class="w-full p-4 bg-gray-50 border rounded-xl text-sm focus:ring-2 ring-blue-500 outline-none transition" rows="3" placeholder="Вашият отговор..."></textarea>
                        <button onclick="checkAI()" id="checkBtn" class="w-full mt-3 py-3 bg-black text-white rounded-xl font-medium ios-btn">Провери</button>
                    </div>
                </div>
                <div class="face back items-center justify-center text-center">
                    <div id="std-back">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Верен Отговор</span>
                        <p id="s-back" class="text-2xl font-medium text-gray-800"></p>
                    </div>
                    <div id="ai-back" class="hidden w-full flex flex-col items-center">
                        <div id="score-circle" class="w-16 h-16 rounded-full border-4 flex items-center justify-center text-lg font-bold mb-4"></div>
                        <p id="ai-feedback-text" class="text-sm text-gray-600 mb-6 px-4"></p>
                        <button onclick="nextCard()" class="w-full py-3 bg-[#007AFF] text-white rounded-xl font-medium ios-btn">Продължи</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="std-controls" class="mt-8 flex gap-4">
            <button onclick="flipSessionCard()" class="px-8 py-3 bg-white border border-gray-200 rounded-full font-medium text-gray-700 hover:bg-gray-50 ios-btn shadow-sm">Обърни</button>
            <button onclick="nextCard()" class="w-12 h-12 bg-black text-white rounded-full flex items-center justify-center ios-btn"><i data-lucide="arrow-right"></i></button>
        </div>
    </section>

    <div id="view-loading" class="hidden-view fixed inset-0 z-[60] bg-white/80 backdrop-blur-xl flex flex-col items-center justify-center fade-in">
        <div class="apple-loader mb-6"></div>
        <h2 class="text-xl font-bold text-gray-800">AI Оценява</h2>
        <p class="text-sm text-gray-500 mt-2">Анализ на резултатите...</p>
    </div>

    <section id="view-summary" class="hidden-view fixed inset-0 z-[50] bg-[#F5F5F7] overflow-y-auto">
        <div class="max-w-2xl mx-auto min-h-screen p-6 flex flex-col">
            <div class="flex-1 mt-10">
                <div class="text-center mb-10">
                    <h1 class="text-4xl font-black text-gray-900 mb-2">Резултат</h1>
                    <div id="final-badge" class="inline-flex items-center justify-center px-4 py-1 rounded-full text-sm font-bold bg-gray-200 text-gray-600">Приключено</div>
                </div>
                <div id="summary-grid" class="space-y-4"></div>
            </div>
            <div class="sticky bottom-6 mt-6 bg-white/90 backdrop-blur-md p-4 rounded-3xl shadow-2xl border border-gray-200 flex gap-4">
                <button onclick="goHome()" class="flex-1 py-3.5 text-gray-600 font-bold bg-gray-100 rounded-xl hover:bg-gray-200 ios-btn">Към Библиотека</button>
                <button onclick="restartDeck()" class="flex-1 py-3.5 bg-[#007AFF] text-white font-bold rounded-xl ios-btn">Учи Отново</button>
            </div>
        </div>
    </section>

    <script>
        // Apply shared StudySpace theme based on saved settings
        (function(){
            const DEFAULT = { accentColor:'#2f6bff', darkMode:false, sound:true, sfx:true };
            let s = { ...DEFAULT };
            function hexToRgbaStart(hex){
                if (!hex || hex[0] !== '#' || (hex.length !== 7 && hex.length !== 4)) return 'rgba(32, 102, 255, 0.72)';
                let r,g,b;
                if (hex.length === 7) {
                    r = parseInt(hex.slice(1,3),16);
                    g = parseInt(hex.slice(3,5),16);
                    b = parseInt(hex.slice(5,7),16);
                } else {
                    r = parseInt(hex[1] + hex[1],16);
                    g = parseInt(hex[2] + hex[2],16);
                    b = parseInt(hex[3] + hex[3],16);
                }
                return `rgba(${r}, ${g}, ${b}, 0.72)`;
            }
            try {
                const raw = localStorage.getItem('studyspace_settings');
                if (raw) s = { ...s, ...JSON.parse(raw) };
            } catch(e) {}
            const root = document.documentElement;
            const accent = s.accentColor || DEFAULT.accentColor;
            root.style.setProperty('--accent', accent);
            root.style.setProperty('--accent-2', accent);
            root.style.setProperty('--grad-start', hexToRgbaStart(accent));
            document.body.classList.toggle('dark-mode', !!s.darkMode);
            window.studyspaceSettings = { soundEnabled: !!s.sound, sfxEnabled: !!s.sfx };
        })();

        const S_URL = "https://zfqpfhtbpfdudbpqzbbg.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmcXBmaHRicGZkdWRicHF6YmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyOTQ5NzQsImV4cCI6MjA4Mzg3MDk3NH0.QnmNeFn9LX9ZIc-bINH_4DNKFeJj9LCYU7QF5ZwfaDE";
        const sb = window.supabase.createClient(S_URL, S_KEY);
        const WORKER = "https://curly-mountain-4c28.boy05geo.workers.dev";

        let currentDeck = null, cards = [], cardIdx = 0, mode = 'standard', results = [], creationQueue = [];

        // Записва/обновява последно използвана библиотека за началната страница
        async function logRecentLibrary(name, deckId) {
            try {
                const { data: { user } } = await sb.auth.getUser();
                if (!user) return;

                await sb.from('recent_libraries').upsert({
                    user_id: user.id,
                    name: name,
                    url: `Flashcardcreate.html?deck=${deckId}`,
                    last_used: new Date().toISOString()
                }, { onConflict: 'user_id, name' });
            } catch (err) {
                console.warn('recent_libraries log failed', err);
            }
        }

        function showView(id) {
            document.querySelectorAll('section, .hidden-view').forEach(el => { if(!el.id.includes('modal')) el.classList.add('hidden-view'); });
            if(id !== 'modal-settings') document.getElementById('modal-settings').classList.add('hidden-view');
            document.getElementById('view-' + id).classList.remove('hidden-view');
            if(id === 'library') loadLibrary();
        }

        function goHome() { showView('library'); }

        // Time capsule removed from this page; functions and state omitted.
        // ---------------------------

        async function loadLibrary() {
            const { data } = await sb.from('decks').select('*').order('created_at', { ascending: false });
            const grid = document.getElementById('deck-grid');
            if(data) {
                grid.innerHTML = data.map(d => `
                    <div onclick="openSettings(${d.id}, '${d.name}')" class="ios-card p-6 rounded-[24px] hover:scale-[1.02] transition cursor-pointer group">
                        <div class="flex justify-between items-start mb-10">
                            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center"><i data-lucide="folder"></i></div>
                            <i data-lucide="chevron-right" class="text-gray-300"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">${d.name}</h3>
                        <p class="text-sm text-gray-400 mt-1">Кликни за преглед</p>
                    </div>
                `).join('');
                lucide.createIcons();
            }
        }

        function openSettings(id, name) {
            currentDeck = { id, name };
            document.getElementById('modal-title').innerText = name;
            document.getElementById('modal-settings').classList.remove('hidden-view');
            toggleMode('standard');
            document.getElementById('shuffle-check').checked = false;
            // отбелязваме, че тази библиотека е отворена наскоро
            logRecentLibrary(name, id);
        }

        function closeModal() { document.getElementById('modal-settings').classList.add('hidden-view'); }

        // Rename / delete helpers
        function openRenameDeck() {
            if (!currentDeck) return;
            const input = document.getElementById('rename-input');
            input.value = currentDeck.name || '';
            document.getElementById('rename-modal').classList.remove('hidden-view');
        }

        function closeRenameModal() {
            document.getElementById('rename-modal').classList.add('hidden-view');
        }

        async function applyRenameDeck() {
            if (!currentDeck) return;
            const input = document.getElementById('rename-input');
            const newName = (input.value || '').trim();
            if (!newName) return;

            try {
                const { error } = await sb.from('decks').update({ name: newName }).eq('id', currentDeck.id);
                if (error) {
                    console.warn('rename deck error', error);
                    return;
                }
                currentDeck.name = newName;
                document.getElementById('modal-title').innerText = newName;
                closeRenameModal();
                await logRecentLibrary(newName, currentDeck.id);
                await loadLibrary();
            } catch (e) {
                console.warn('rename deck failed', e);
            }
        }

        function confirmDeleteDeck() {
            if (!currentDeck) return;
            document.getElementById('delete-name').innerText = currentDeck.name || '';
            document.getElementById('delete-modal').classList.remove('hidden-view');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden-view');
        }

        async function performDeleteDeck() {
            if (!currentDeck) return;
            const deckId = currentDeck.id;
            try {
                // Първо изтриваме картите в тази папка
                await sb.from('flashcards').delete().eq('deck_id', deckId);
                // После самата папка
                await sb.from('decks').delete().eq('id', deckId);

                // Премахваме я и от recent_libraries за текущия потребител
                try {
                    const { data: { user } } = await sb.auth.getUser();
                    if (user) {
                        await sb
                            .from('recent_libraries')
                            .delete()
                            .eq('user_id', user.id)
                            .eq('url', `Flashcardcreate.html?deck=${deckId}`);
                    }
                } catch (e) {
                    console.warn('recent_libraries cleanup failed', e);
                }

                closeDeleteModal();
                closeModal();
                currentDeck = null;
                await loadLibrary();
            } catch (e) {
                console.warn('delete deck failed', e);
            }
        }
        function toggleMode(m) {
            mode = m;
            const bg = document.getElementById('toggle-bg');
            const tStd = document.getElementById('t-std'), tAi = document.getElementById('t-ai');
            if (m === 'standard') { bg.style.left = '4px'; tStd.classList.replace('text-gray-400', 'text-black'); tAi.classList.replace('text-black', 'text-gray-400'); }
            else { bg.style.left = '50%'; tStd.classList.replace('text-black', 'text-gray-400'); tAi.classList.replace('text-gray-400', 'text-black'); }
        }

        async function startSession() {
            const { data } = await sb.from('flashcards').select('*').eq('deck_id', currentDeck.id);
            if(!data || data.length === 0) { alert('Папката е празна.'); return; }
            cards = [...data];
            if(document.getElementById('shuffle-check').checked) cards.sort(() => Math.random() - 0.5);
            cardIdx = 0; results = []; closeModal(); showView('focus'); setupCardUI();
        }

        function setupCardUI() {
            const c = cards[cardIdx];
            document.getElementById('s-front').innerText = c.front; document.getElementById('s-back').innerText = c.back;
            document.getElementById('sessionCard').classList.remove('flipped');
            document.getElementById('ai-user-ans').value = '';
            document.getElementById('counter').innerText = `${cardIdx + 1}/${cards.length}`;
            document.getElementById('progress-fill').style.width = `${((cardIdx)/cards.length)*100}%`;
            
            const isAI = mode === 'ai';
            document.getElementById('std-controls').classList.toggle('hidden', isAI);
            document.getElementById('ai-input-box').classList.toggle('hidden', !isAI);
            document.getElementById('std-back').classList.toggle('hidden', isAI);
            document.getElementById('ai-back').classList.toggle('hidden', !isAI);
        }

        function flipSessionCard() { document.getElementById('sessionCard').classList.toggle('flipped'); }

        async function checkAI() {
            const uAns = document.getElementById('ai-user-ans').value; if(!uAns) return;
            const btn = document.getElementById('checkBtn'); btn.innerText = "Оценяване...";
            try {
                const res = await fetch(WORKER, { method: 'POST', body: JSON.stringify({ prompt: `Rate 0-100. Q:${cards[cardIdx].front} A:${cards[cardIdx].back} Student:${uAns}. JSON only: {"score":number, "feedback":string}` }) });
                const data = await res.json();
                let g = { score: 0, feedback: data.answer };
                try { const m = data.answer.match(/\{[\s\S]*\}/); if(m) g = JSON.parse(m[0]); } catch(e){}
                
                document.getElementById('score-circle').innerText = g.score + '%';
                document.getElementById('score-circle').className = `w-16 h-16 rounded-full border-4 flex items-center justify-center text-lg font-bold mb-4 ${g.score > 60 ? 'border-green-500 text-green-600 bg-green-50' : 'border-red-500 text-red-600 bg-red-50'}`;
                document.getElementById('ai-feedback-text').innerText = g.feedback;
                
                results.push({ ...cards[cardIdx], score: g.score, userAns: uAns, correct: g.score > 60 });
                document.getElementById('sessionCard').classList.add('flipped');
            } catch(e) { console.log(e); alert("Error"); }
            btn.innerText = "Провери";
        }

        function nextCard() { if(cardIdx < cards.length - 1) { cardIdx++; setupCardUI(); } else { finishSession(); } }

        function finishSession() {
            if(mode === 'ai') {
                document.getElementById('view-focus').classList.add('hidden-view');
                document.getElementById('view-loading').classList.remove('hidden-view');
                setTimeout(() => { document.getElementById('view-loading').classList.add('hidden-view'); renderSummary(); }, 2500);
            } else { renderSummary(); }
        }

        function renderSummary() {
            showView('summary'); confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            const grid = document.getElementById('summary-grid'), badge = document.getElementById('final-badge');
            if (mode === 'standard') {
                badge.innerText = "Преговор"; badge.className = "inline-flex items-center justify-center px-4 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-600";
                grid.innerHTML = `<div class="text-center py-20 text-gray-400">Преминахте успешно през ${cards.length} карти.</div>`;
            } else {
                const avg = Math.round(results.reduce((a,b)=>a+b.score,0)/results.length) || 0;
                badge.innerText = `Среден успех: ${avg}%`;
                badge.className = `inline-flex items-center justify-center px-4 py-1 rounded-full text-sm font-bold ${avg>=60 ? 'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`;
                grid.innerHTML = results.map((r, i) => `
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm flex flex-col gap-2">
                        <div class="flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase">Карта ${i+1}</span><span class="font-bold ${r.correct?'text-green-500':'text-red-500'}">${r.score}%</span></div>
                        <p class="font-bold text-gray-800">${r.front}</p>
                        <p class="text-sm text-gray-500 bg-gray-50 p-2 rounded-lg">Ти: "${r.userAns}"</p>
                    </div>`).join('');
            }
        }

        function restartDeck() { openSettings(currentDeck.id, currentDeck.name); }
        function flipBack() { document.getElementById('createCard').classList.remove('flipped'); }
        async function runAI() {
            const q = document.getElementById('q-in').value; if(!q) return;
            const btn = document.getElementById('genBtn'); btn.innerHTML = `<div class="apple-loader w-4 h-4 mr-2 border-white"></div>`;
            try { const res = await fetch(WORKER, { method: 'POST', body: JSON.stringify({ prompt: q }) }); const data = await res.json(); document.getElementById('a-out').value = data.answer; document.getElementById('createCard').classList.add('flipped'); } catch(e){}
            btn.innerHTML = `<i data-lucide="sparkles" class="w-4 h-4"></i> Авто-генериране`;
        }
        function addToQueue() { const f = document.getElementById('q-in').value, b = document.getElementById('a-out').value; if(f&&b) { creationQueue.push({front:f, back:b}); updateQueueUI(); flipBack(); document.getElementById('q-in').value=''; } }
        function updateQueueUI() { document.getElementById('q-count').innerText = creationQueue.length; document.getElementById('carousel').innerHTML = creationQueue.map(c => `<div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold shrink-0 border border-blue-200">?</div>`).join(''); }
        async function saveAll() {
            const name = document.getElementById('deck-in').value || 'Нова папка';
            let { data: deck } = await sb.from('decks').select('id').eq('name', name).maybeSingle();
            if(!deck) { const { data } = await sb.from('decks').insert({name}).select().single(); deck = data; }
            await sb.from('flashcards').insert(creationQueue.map(c => ({...c, deck_id: deck.id})));

            // отбелязваме новата/обновената библиотека като последно използвана
            if (deck && deck.id) await logRecentLibrary(name, deck.id);

            creationQueue = []; updateQueueUI(); goHome();
        }

        window.onload = () => { lucide.createIcons(); loadLibrary(); };
    </script>
</body>
</html>
