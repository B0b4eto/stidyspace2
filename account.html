<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–≤–æ—è—Ç –ü—Ä–æ—Ñ–∏–ª ‚Äî StudySpace</title>
    
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700,900&display=swap" rel="stylesheet" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>

    <style>
        :root {
            --bg: #f5f5f7;
            --theme-color: #0071e3;
            --text-main: #1d1d1f;
            --text-sub: #86868b;
            --card-bg: rgba(255, 255, 255, 0.8);
            --border: rgba(0, 0, 0, 0.05);
            --danger: #ff3b30;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        .background-blobs {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1;
            background: radial-gradient(circle at 10% 20%, rgba(0, 113, 227, 0.03) 0%, transparent 40%);
        }

        /* --- NAV --- */
        nav {
            position: fixed; top: 0; width: 100%; padding: 15px 5%; z-index: 100;
            backdrop-filter: blur(20px); background: rgba(255, 255, 255, 0.7);
            border-bottom: 1px solid var(--border); display: grid;
            grid-template-columns: 1fr auto 1fr; align-items: center;
        }
        .home-btn { font-size: 22px; text-decoration: none; color: var(--text-main); transition: 0.3s; }
        .nav-center-title { grid-column: 2; font-weight: 700; font-size: 17px; }

        /* --- CONTAINER --- */
        .main-container { position: relative; z-index: 10; max-width: 1000px; margin: 0 auto; padding: 100px 20px; }
        .profile-grid { display: grid; grid-template-columns: 320px 1fr; gap: 30px; margin-top: 20px; }
        .glass-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 24px; padding: 35px; backdrop-filter: blur(30px); box-shadow: 0 15px 35px rgba(0,0,0,0.03); }

        /* --- AVATAR & CROPPER --- */
        .avatar-section { text-align: center; }
        .avatar-wrap { position: relative; width: 160px; height: 160px; margin: 0 auto 20px; }
        .profile-pic { width: 100%; height: 100%; border-radius: 40px; object-fit: cover; border: 5px solid white; box-shadow: 0 10px 25px rgba(0,0,0,0.06); }
        .upload-btn { position: absolute; bottom: -5px; right: -5px; background: white; border: 1px solid var(--border); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.08); z-index: 5; }

        /* Cropper Modal */
        #cropper-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 2000; align-items: center; justify-content: center; }
        .cropper-container { background: white; padding: 25px; border-radius: 30px; width: 90%; max-width: 450px; text-align: center; }
        
        /* --- FORM --- */
        .field { margin-bottom: 20px; }
        .field label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 8px; margin-left: 5px; }
        .field input, .field select { width: 100%; padding: 14px 18px; background: #fff; border: 1px solid rgba(0,0,0,0.1); border-radius: 14px; font-size: 16px; outline: none; transition: 0.3s; }
        .field input:focus { border-color: var(--theme-color); box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1); }
        .btn-save { width: 100%; padding: 16px; background: var(--theme-color); color: white; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; transition: 0.3s; }

        /* --- APPLE CALENDAR OVERRIDE --- */
        .flatpickr-calendar { border-radius: 20px !important; box-shadow: 0 15px 40px rgba(0,0,0,0.1) !important; border: none !important; padding: 10px; }
        .flatpickr-day.selected { background: var(--theme-color) !important; border-radius: 10px; }

        /* --- LOGOUT POPUP --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-card { background: white; padding: 30px; border-radius: 20px; width: 300px; text-align: center; }
        .sign-out-btn { margin-top: 40px; color: var(--danger); font-weight: 600; cursor: pointer; background: white; border: 1px solid rgba(255,43,48,0.1); padding: 12px 30px; border-radius: 12px; }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 12px 25px; background: #1d1d1f; color: white; border-radius: 50px; font-size: 14px; opacity: 0; transition: 0.4s; z-index: 3000; }
        .toast.show { opacity: 1; bottom: 50px; }
    </style>
</head>
<body>

    <div class="background-blobs"></div>

    <nav>
        <a href="homepage (3).html" class="home-btn">üè†</a>
        <div class="nav-center-title">–ü—Ä–æ—Ñ–∏–ª</div>
        <div></div>
    </nav>

    <div class="main-container">
        <div class="profile-grid">
            <aside class="glass-card avatar-section">
                <div class="avatar-wrap">
                    <img id="profile-img" src="https://via.placeholder.com/160" class="profile-pic">
                    <label class="upload-btn">
                        üì∑
                        <input type="file" id="avatar-input" hidden accept="image/*">
                    </label>
                </div>
                <h2 id="display-name" style="font-size: 20px;">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª</h2>
                <p id="display-email" style="font-size: 13px; color: var(--text-sub);"></p>
            </aside>

            <main class="glass-card">
                <form id="profile-form">
                    <div class="field"><label>–ò–º–µ–π–ª</label><input type="email" id="email" readonly></div>
                    <div class="field"><label>–ü—ä–ª–Ω–æ –∏–º–µ</label><input type="text" id="full_name" placeholder="–¢–≤–æ–µ—Ç–æ –∏–º–µ"></div>
                    <div class="field"><label>–î–∞—Ç–∞ –Ω–∞ —Ä–∞–∂–¥–∞–Ω–µ</label><input type="text" id="birthday" placeholder="–ò–∑–±–µ—Ä–∏ –¥–∞—Ç–∞"></div>
                    <div class="field"><label>–ì—Ä–∞–¥ / –î—ä—Ä–∂–∞–≤–∞</label><input type="text" id="location" placeholder="–°–æ—Ñ–∏—è, –ë—ä–ª–≥–∞—Ä–∏—è"></div>
                    <div class="field">
                        <label>–ï–∑–∏–∫</label>
                        <select id="language"><option value="bg">–ë—ä–ª–≥–∞—Ä—Å–∫–∏</option><option value="en">English</option></select>
                    </div>
                    <button type="submit" class="btn-save">–ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ</button>
                </form>
            </main>
        </div>

        <div style="text-align:center"><button class="sign-out-btn" onclick="toggleLogoutModal(true)">–ò–∑—Ö–æ–¥ –æ—Ç –∞–∫–∞—É–Ω—Ç–∞</button></div>
    </div>

    <div id="cropper-modal">
        <div class="cropper-container">
            <h3 style="margin-bottom:15px">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —Å–Ω–∏–º–∫–∞—Ç–∞</h3>
            <div id="cropper-viewport"></div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-save" style="background:#f2f2f7; color:black;" onclick="closeCropper()">–û—Ç–∫–∞–∑</button>
                <button class="btn-save" id="crop-result">–ó–∞–ø–∞–∑–∏ —Å–Ω–∏–º–∫–∞—Ç–∞</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="logoutModal">
        <div class="modal-card">
            <h3>–ò–∑—Ö–æ–¥?</h3>
            <p style="margin: 15px 0; font-size:14px; color:var(--text-sub)">–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ?</p>
            <button class="btn-save" style="background:var(--danger); margin-bottom:10px" onclick="signOut()">–î–∞, –∏–∑–ª–µ–∑</button>
            <button class="btn-save" style="background:#f2f2f7; color:black" onclick="toggleLogoutModal(false)">–û—Ç–∫–∞–∑</button>
        </div>
    </div>

    <div id="toast" class="toast">–ó–∞–ø–∞–∑–µ–Ω–æ!</div>

    <script>
        const SUPABASE_URL = '–¢–í–û–Ø–¢_URL';
        const SUPABASE_KEY = '–¢–í–û–Ø–¢_KEY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let croppieInstance = null;

        // 1. Initialize Calendar
        flatpickr("#birthday", { dateFormat: "Y-m-d", locale: "bg" });

        // 2. Load Profile
        async function loadProfile() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) { window.location.href = 'login.html'; return; }

            document.getElementById('email').value = user.email;
            document.getElementById('display-email').innerText = user.email;

            let { data } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
            if (data) {
                document.getElementById('full_name').value = data.full_name || '';
                document.getElementById('display-name').innerText = data.full_name || '–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª';
                document.getElementById('location').value = data.location || '';
                document.getElementById('language').value = data.language || 'bg';
                document.getElementById('birthday')._flatpickr.setDate(data.birthday);
                if (data.avatar_url) document.getElementById('profile-img').src = data.avatar_url;
            }
        }

        // 3. Handle Profile Save
        document.getElementById('profile-form').onsubmit = async (e) => {
            e.preventDefault();
            const { data: { user } } = await supabaseClient.auth.getUser();
            const updates = {
                id: user.id,
                full_name: document.getElementById('full_name').value,
                birthday: document.getElementById('birthday').value,
                location: document.getElementById('location').value,
                language: document.getElementById('language').value,
                updated_at: new Date(),
            };
            const { error } = await supabaseClient.from('profiles').upsert(updates);
            if (error) alert(error.message); else showToast("–ü—Ä–æ—Ñ–∏–ª—ä—Ç –µ –æ–±–Ω–æ–≤–µ–Ω!");
        };

        // 4. Image Cropping Logic
        document.getElementById('avatar-input').onchange = function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('cropper-modal').style.display = 'flex';
                    if (croppieInstance) croppieInstance.destroy();
                    croppieInstance = new Croppie(document.getElementById('cropper-viewport'), {
                        viewport: { width: 200, height: 200, type: 'square' }, // Squircle style
                        boundary: { width: 300, height: 300 },
                        showZoomer: true
                    });
                    croppieInstance.bind({ url: e.target.result });
                }
                reader.readAsDataURL(this.files[0]);
            }
        };

        document.getElementById('crop-result').onclick = async function() {
            croppieInstance.result({ type: 'blob', size: 'viewport', format: 'jpeg' }).then(async (blob) => {
                const { data: { user } } = await supabaseClient.auth.getUser();
                const fileName = `avatars/${user.id}-${Date.now()}.jpg`;
                
                let { error: upErr } = await supabaseClient.storage.from('avatars').upload(fileName, blob);
                if (upErr) return alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–∞—á–≤–∞–Ω–µ");

                const { data } = supabaseClient.storage.from('avatars').getPublicUrl(fileName);
                await supabaseClient.from('profiles').update({ avatar_url: data.publicUrl }).eq('id', user.id);
                
                document.getElementById('profile-img').src = data.publicUrl;
                closeCropper();
                showToast("–°–Ω–∏–º–∫–∞—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞!");
            });
        };

        function closeCropper() { document.getElementById('cropper-modal').style.display = 'none'; }
        function toggleLogoutModal(s) { document.getElementById('logoutModal').style.display = s ? 'flex' : 'none'; }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }
        async function signOut() { await supabaseClient.auth.signOut(); window.location.href = 'login.html'; }

        loadProfile();
    </script>
</body>
</html>
