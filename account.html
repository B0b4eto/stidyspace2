<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Твоят Профил — StudySpace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700,900&display=swap" rel="stylesheet" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>

    <style>
        :root {
            --bg: #f5f5f7;
            --accent: #0b63c7;
            --accent-2: #009fe6;
            --grad-start: rgba(32, 102, 255, 0.72);
            --grad-end: rgba(255, 255, 255, 0.5);
            --theme-color: var(--accent);
            --text-main: #1d1d1f;
            --text-sub: #86868b;
            --card-bg: rgba(255, 255, 255, 0.8);
            --border: rgba(0, 0, 0, 0.05);
            --danger: #ff3b30;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Montserrat', sans-serif;
            background:
                linear-gradient(180deg, var(--grad-start), var(--grad-end));
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        .background-blobs {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1;
            background: radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 40%);
        }

        /* --- NAV --- */
        nav {
            position: fixed; top: 0; width: 100%; padding: 15px 5%; z-index: 100;
            backdrop-filter: blur(20px); background: rgba(255, 255, 255, 0.7);
            border-bottom: 1px solid var(--border); display: grid;
            grid-template-columns: 1fr auto 1fr; align-items: center;
        }
        .home-btn { font-size: 22px; text-decoration: none; color: var(--text-main); transition: 0.3s; display:inline-flex; align-items:center; justify-content:center; }
        .nav-center-title { grid-column: 2; font-weight: 700; font-size: 17px; }

        /* --- CONTAINER --- */
        .main-container { position: relative; z-index: 10; max-width: 1000px; margin: 0 auto; padding: 100px 20px; }
        .profile-grid { display: grid; grid-template-columns: 320px 1fr; gap: 30px; margin-top: 20px; }
        .glass-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 24px; padding: 35px; backdrop-filter: blur(30px); box-shadow: 0 15px 35px rgba(0,0,0,0.03); }

        /* --- AVATAR & CROPPER --- */
        .avatar-section { text-align: center; }
        .avatar-wrap { position: relative; width: 160px; height: 160px; margin: 0 auto 20px; }
        .profile-pic { width: 100%; height: 100%; border-radius: 40px; object-fit: cover; border: 5px solid white; box-shadow: 0 10px 25px rgba(0,0,0,0.06); }
        .upload-btn { position: absolute; bottom: -5px; right: -5px; background: white; border: 1px solid var(--border); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.08); z-index: 5; font-size: 16px; }

        /* Cropper Modal */
        #cropper-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 2000; align-items: center; justify-content: center; }
        .cropper-container { background: white; padding: 25px; border-radius: 30px; width: 90%; max-width: 450px; text-align: center; }
        
        /* --- FORM --- */
        .field { margin-bottom: 20px; }
        .field label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 8px; margin-left: 5px; }
        .field input, .field select { width: 100%; padding: 14px 18px; background: #fff; border: 1px solid rgba(0,0,0,0.1); border-radius: 14px; font-size: 16px; outline: none; transition: 0.3s; }
        .field input:focus { border-color: var(--theme-color); box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1); }
        .btn-save { width: 100%; padding: 16px; background: var(--theme-color); color: white; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; transition: 0.3s; }

        /* --- APPLE CALENDAR OVERRIDE --- */
        .flatpickr-calendar { border-radius: 20px !important; box-shadow: 0 15px 40px rgba(0,0,0,0.1) !important; border: none !important; padding: 10px; }
        .flatpickr-day.selected { background: var(--theme-color) !important; border-radius: 10px; }

        /* --- LOGOUT POPUP --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-card { background: white; padding: 30px; border-radius: 20px; width: 300px; text-align: center; }
        .sign-out-btn { margin-top: 40px; color: var(--danger); font-weight: 600; cursor: pointer; background: white; border: 1px solid rgba(255,43,48,0.1); padding: 12px 30px; border-radius: 12px; }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 12px 25px; background: #1d1d1f; color: white; border-radius: 50px; font-size: 14px; opacity: 0; transition: 0.4s; z-index: 3000; }
        .toast.show { opacity: 1; bottom: 50px; }

        /* Dark mode tweaks to match homepage */
        body.dark-mode {
            color: #e5e7eb;
            background:
                linear-gradient(180deg, rgba(15,23,42,0.96), rgba(15,23,42,0.92));
        }
        body.dark-mode nav { background: rgba(15,23,42,0.85); border-color: rgba(148,163,184,0.4); }
        body.dark-mode .glass-card { background: rgba(15,23,42,0.9); border-color: rgba(148,163,184,0.35); box-shadow: 0 18px 40px rgba(0,0,0,0.45); }
        body.dark-mode .field input,
        body.dark-mode .field select { background: rgba(15,23,42,0.9); border-color: rgba(55,65,81,0.9); color: #e5e7eb; }
        body.dark-mode .field label { color: #9ca3af; }
        body.dark-mode .btn-save { box-shadow: 0 10px 26px rgba(37,99,235,0.6); }
    </style>
</head>
<body>

    <div class="background-blobs"></div>

    <nav>
        <a href="homepage (3).html" class="home-btn" aria-label="Начало">
            <i class="fa-solid fa-house-chimney"></i>
        </a>
        <div class="nav-center-title">Профил</div>
        <div></div>
    </nav>

    <div class="main-container">
        <div class="profile-grid">
            <aside class="glass-card avatar-section">
                <div class="avatar-wrap">
                    <img id="profile-img" src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22128%22%20height%3D%22128%22%20viewBox%3D%220%200%20128%20128%22%3E%3Cdefs%3E%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20x2%3D%221%22%20y1%3D%220%22%20y2%3D%221%22%3E%3Cstop%20stop-color%3D%22%23009fe6%22%2F%3E%3Cstop%20offset%3D%221%22%20stop-color%3D%22%230b63c7%22%2F%3E%3C%2FlinearGradient%3E%3C%2Fdefs%3E%3Ccircle%20cx%3D%2264%22%20cy%3D%2264%22%20r%3D%2264%22%20fill%3D%22url%28%23g%29%22%2F%3E%3Ccircle%20cx%3D%2264%22%20cy%3D%2250%22%20r%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.92%29%22%2F%3E%3Cpath%20d%3D%22M24%20118c9-20%2027-32%2040-32s31%2012%2040%2032%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.92%29%22%2F%3E%3C%2Fsvg%3E" class="profile-pic" alt="Профил">
                    <label class="upload-btn" aria-label="Качи снимка">
                        <i class="fa-solid fa-camera"></i>
                        <input type="file" id="avatar-input" hidden accept="image/*">
                    </label>
                </div>
                <h2 id="display-name" style="font-size: 20px;">Потребител</h2>
                <p id="display-email" style="font-size: 13px; color: var(--text-sub);"></p>
            </aside>

            <main class="glass-card">
                <form id="profile-form">
                    <div class="field"><label>Имейл</label><input type="email" id="email" readonly></div>
                    <div class="field"><label>Пълно име</label><input type="text" id="full_name" placeholder="Твоето име"></div>
                    <div class="field"><label>Дата на раждане</label><input type="text" id="birthday" placeholder="Избери дата"></div>
                    <div class="field"><label>Град / Държава</label><input type="text" id="location" placeholder="София, България"></div>
                    <div class="field">
                        <label>Език</label>
                        <select id="language"><option value="bg">Български</option><option value="en">English</option></select>
                    </div>
                    <button type="submit" class="btn-save">Запази промените</button>
                </form>
            </main>
        </div>

        <div style="text-align:center"><button class="sign-out-btn" onclick="toggleLogoutModal(true)">Изход от акаунта</button></div>
    </div>

    <div id="cropper-modal">
        <div class="cropper-container">
            <h3 style="margin-bottom:15px">Редактирай снимката</h3>
            <div id="cropper-viewport"></div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-save" style="background:#f2f2f7; color:black;" onclick="closeCropper()">Отказ</button>
                <button class="btn-save" id="crop-result">Запази снимката</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="logoutModal">
        <div class="modal-card">
            <h3>Изход?</h3>
            <p style="margin: 15px 0; font-size:14px; color:var(--text-sub)">Сигурни ли сте?</p>
            <button class="btn-save" style="background:var(--danger); margin-bottom:10px" onclick="signOut()">Да, излез</button>
            <button class="btn-save" style="background:#f2f2f7; color:black" onclick="toggleLogoutModal(false)">Отказ</button>
        </div>
    </div>

    <div id="toast" class="toast">Запазено!</div>

    <script>
        // Apply shared StudySpace theme based on saved settings
        (function(){
            const DEFAULT = { accentColor:'#2f6bff', darkMode:false, sound:true, sfx:true };
            let s = { ...DEFAULT };
            function hexToRgbaStart(hex){
                if (!hex || hex[0] !== '#' || (hex.length !== 7 && hex.length !== 4)) return 'rgba(32, 102, 255, 0.72)';
                let r,g,b;
                if (hex.length === 7) {
                    r = parseInt(hex.slice(1,3),16);
                    g = parseInt(hex.slice(3,5),16);
                    b = parseInt(hex.slice(5,7),16);
                } else {
                    r = parseInt(hex[1] + hex[1],16);
                    g = parseInt(hex[2] + hex[2],16);
                    b = parseInt(hex[3] + hex[3],16);
                }
                return `rgba(${r}, ${g}, ${b}, 0.72)`;
            }
            try {
                const raw = localStorage.getItem('studyspace_settings');
                if (raw) s = { ...s, ...JSON.parse(raw) };
            } catch(e) {}
            const root = document.documentElement;
            const accent = s.accentColor || DEFAULT.accentColor;
            root.style.setProperty('--accent', accent);
            root.style.setProperty('--accent-2', accent);
            root.style.setProperty('--grad-start', hexToRgbaStart(accent));
            document.body.classList.toggle('dark-mode', !!s.darkMode);
            window.studyspaceSettings = { soundEnabled: !!s.sound, sfxEnabled: !!s.sfx };
        })();

    </script>

    <script>
        // Read Supabase config from meta tags (preferred) or fall back to hardcoded values
        const SUPABASE_URL = document.querySelector('meta[name="supabase-url"]')?.content || 'https://zfqpfhtbpfdudbpqzbbg.supabase.co';
        const SUPABASE_KEY = document.querySelector('meta[name="supabase-key"]')?.content || 'sb_publishable_-pHOflGGasRf4o18KIXXQg_OPRhB6gK';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Cached DOM nodes
        const profileImg = document.getElementById('profile-img');
        const avatarInput = document.getElementById('avatar-input');
        const cropperModal = document.getElementById('cropper-modal');
        const cropperViewport = document.getElementById('cropper-viewport');
        const displayName = document.getElementById('display-name');
        const displayEmail = document.getElementById('display-email');
        const fullNameInput = document.getElementById('full_name');
        const birthdayInput = document.getElementById('birthday');
        const locationInput = document.getElementById('location');
        const languageSelect = document.getElementById('language');
        const profileForm = document.getElementById('profile-form');
        const toastEl = document.getElementById('toast');
        const logoutModal = document.getElementById('logoutModal');

        let croppieInstance = null;
        let flatpickrInstance = null;
        let currentUser = null;
        let toastTimer = null;

        const DEFAULT_AVATAR = 'data:image/svg+xml,' + encodeURIComponent(
            '<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><defs><radialGradient id="bg" cx="0.3" cy="0.2" r="0.8"><stop offset="0%" stop-color="#e7f3ff"/><stop offset="55%" stop-color="#c7ddff"/><stop offset="100%" stop-color="#a9c7ff"/></radialGradient></defs><circle cx="80" cy="80" r="76" fill="url(#bg)"/><circle cx="80" cy="64" r="28" fill="#fdfefe"/><path d="M34 132c8-22 25-36 46-36s38 14 46 36" fill="#fdfefe"/></svg>'
        );
        profileImg.src = DEFAULT_AVATAR;
        profileImg.onerror = () => { profileImg.src = DEFAULT_AVATAR; };

        // Initialize flatpickr and keep the instance for later
        flatpickrInstance = flatpickr(birthdayInput, { dateFormat: 'Y-m-d', locale: 'bg' });

        async function getCurrentUser() {
            if (currentUser) return currentUser;
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                currentUser = user;
                return user;
            } catch (err) {
                console.error('getUser failed', err);
                return null;
            }
        }

        async function loadProfile() {
            try {
                const user = await getCurrentUser();
                if (!user) { window.location.href = 'login.html'; return; }

                profileForm.querySelector('#email').value = user.email || '';
                displayEmail.innerText = user.email || '';

                const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
                if (error && error.code !== 'PGRST116') console.warn('profiles select error', error);
                if (data) {
                    fullNameInput.value = data.full_name || '';
                    displayName.innerText = data.full_name || 'Потребител';
                    locationInput.value = data.location || '';
                    languageSelect.value = data.language || 'bg';
                    if (data.birthday && flatpickrInstance) flatpickrInstance.setDate(data.birthday, true);
                    if (data.avatar_url) profileImg.src = data.avatar_url;
                    else profileImg.src = DEFAULT_AVATAR;
                }
            } catch (err) {
                console.error('loadProfile error', err);
                showToast('Грешка при зареждане на профила');
            }
        }

        // Save profile changes
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const user = await getCurrentUser();
                if (!user) return showToast('Не сте вписани');

                const updates = {
                    id: user.id,
                    full_name: fullNameInput.value,
                    birthday: birthdayInput.value,
                    location: locationInput.value,
                    language: languageSelect.value,
                    updated_at: new Date().toISOString(),
                };

                const { error } = await supabaseClient.from('profiles').upsert(updates);
                if (error) {
                    console.error('upsert error', error);
                    showToast('Грешка при запазване');
                } else {
                    showToast('Профилът е обновен!');
                }
            } catch (err) {
                console.error('save profile failed', err);
                showToast('Грешка при запазване');
            }
        });

        // Image Cropping: open modal & init Croppie
        avatarInput.addEventListener('change', function () {
            const file = this.files && this.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (ev) {
                cropperModal.style.display = 'flex';
                if (croppieInstance) {
                    try { croppieInstance.destroy(); } catch (e) { /* ignore */ }
                    croppieInstance = null;
                }

                croppieInstance = new Croppie(cropperViewport, {
                    viewport: { width: 200, height: 200, type: 'square' },
                    boundary: { width: 300, height: 300 },
                    showZoomer: true
                });
                croppieInstance.bind({ url: ev.target.result });
            };
            reader.readAsDataURL(file);
        });

        // Crop & upload
        document.getElementById('crop-result').addEventListener('click', async () => {
            if (!croppieInstance) return showToast('Няма изображение за запазване');
            try {
                const blob = await croppieInstance.result({ type: 'blob', size: 'viewport', format: 'jpeg' });
                const user = await getCurrentUser();
                if (!user) return showToast('Не сте вписани');

                const fileName = `avatars/${user.id}-${Date.now()}.jpg`;

                const { error: upErr } = await supabaseClient.storage.from('avatars').upload(fileName, blob, { contentType: 'image/jpeg' });
                if (upErr) { console.error('upload err', upErr); return showToast('Грешка при качване'); }

                const { data } = supabaseClient.storage.from('avatars').getPublicUrl(fileName);
                if (data?.publicUrl) {
                    // Записваме/създаваме ред в profiles с avatar_url,
                    // за да може началната страница да го прочете.
                    const { error: profErr } = await supabaseClient
                        .from('profiles')
                        .upsert({
                            id: user.id,
                            avatar_url: data.publicUrl,
                            updated_at: new Date().toISOString()
                        });

                    if (profErr) console.warn('profiles upsert avatar_url error', profErr);

                    profileImg.src = data.publicUrl;
                    closeCropper();
                    showToast('Снимката е обновена!');
                } else {
                    showToast('Неуспешен публичен URL');
                }
            } catch (err) {
                console.error('crop upload failed', err);
                showToast('Грешка при качване');
            }
        });

        function closeCropper() { cropperModal.style.display = 'none'; }
        function toggleLogoutModal(s) { logoutModal.style.display = s ? 'flex' : 'none'; }

        function showToast(m) {
            toastEl.innerText = m;
            toastEl.classList.add('show');
            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => toastEl.classList.remove('show'), 3000);
        }

        async function signOut() {
            try {
                await supabaseClient.auth.signOut();
            } catch (err) {
                console.warn('signOut error', err);
            }
            window.location.href = 'login.html';
        }

        // Expose small helpers for existing inline attributes (keeps backward compatibility)
        window.toggleLogoutModal = toggleLogoutModal;
        window.closeCropper = closeCropper;
        window.signOut = signOut;

        // Kick off
        loadProfile();
    </script>
</body>
</html>


