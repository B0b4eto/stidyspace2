<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Твоят Профил — StudySpace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700,900&display=swap" rel="stylesheet" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>

    <style>
        :root {
            --bg: #f5f5f7;
            --accent: #0b63c7;
            --accent-2: #009fe6;
            --grad-start: rgba(32, 102, 255, 0.72);
            --grad-end: rgba(255, 255, 255, 0.5);
            --theme-color: var(--accent);
            --text-main: #1d1d1f;
            --text-sub: #86868b;
            --card-bg: rgba(255, 255, 255, 0.8);
            --border: rgba(0, 0, 0, 0.05);
            --danger: #ff3b30;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Montserrat', sans-serif;
            /* Smooth gradient that fades into the solid background,
               so the profile page doesn't show harsh horizontal lines. */
            background:linear-gradient(
                180deg,
                var(--grad-start) 0,
                var(--grad-end) 420px,
                var(--bg) 840px,
                var(--bg) 100%
            );
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        .background-blobs {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1;
            background: radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 40%);
        }

        /* --- FRAME + TOPBAR (copied from homepage for 1:1 look) --- */
        .frame{
            width:100vw;
            max-width:100%;
            background:transparent;
            border-radius:0;
            padding:clamp(18px,3.2vw,36px) clamp(20px,4vw,56px);
            -webkit-backdrop-filter:none;
            backdrop-filter:none;
            border:0;
            box-shadow:none;
            margin:0;
            position:relative;
            overflow:visible;
            z-index:10;
        }

        .topbar{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:12px 8px;
            gap:clamp(10px,1.4vw,18px);
            background:transparent;
        }

        .icon-btn{
            width:56px;
            height:56px;
            border-radius:999px;
            display:flex;
            align-items:center;
            justify-content:center;
            background:linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.06));
            border:1px solid rgba(255,255,255,0.12);
            box-shadow:0 8px 20px rgba(4,30,60,0.12);
            position:relative;
            overflow:hidden;
            backdrop-filter:blur(6px);
            cursor:pointer;
        }

        .icon-btn::before{
            content:'';
            position:absolute;
            left:0;top:0;right:0;bottom:0;
            border-radius:999px;
            pointer-events:none;
            z-index:1;
            mix-blend-mode:screen;
            background:radial-gradient(circle at var(--mx,50%) var(--my,50%), rgba(255,255,255,0.92) 0%, rgba(255,255,255,0.40) 18%, rgba(255,255,255,0.18) 36%, rgba(255,255,255,0.04) 60%, transparent 75%);
            opacity:var(--ref-opacity,0);
            transition:opacity 360ms ease, transform 260ms ease;
            filter:blur(6px);
        }

        .center-pill{flex:1;display:flex;justify-content:center;padding:0 8px}

        .pill{
            width:min(1100px,92%);
            background:linear-gradient(90deg, rgba(255,255,255,0.10), rgba(240,250,255,0.06));
            border-radius:40px;
            padding:12px 28px;
            border:1px solid rgba(255,255,255,0.12);
            display:flex;
            justify-content:center;
            gap:24px;
            font-weight:800;
            align-items:center;
            position:relative;
            overflow:visible;
            backdrop-filter:blur(6px);
        }

        .pill span{font-size:clamp(15px,1.4vw,18px);color:#e6f5ff;position:relative;z-index:2}

        /* faint mouse-position reflection for pill (like homepage) */
        .pill{overflow:hidden}
        .pill::before{
            content:'';position:absolute;left:0;top:0;right:0;bottom:0;border-radius:40px;pointer-events:none;z-index:1;mix-blend-mode:screen;
            background:radial-gradient(circle at var(--mx,50%) var(--my,50%), rgba(255,255,255,0.92) 0%, rgba(255,255,255,0.42) 16%, rgba(255,255,255,0.18) 34%, rgba(255,255,255,0.06) 60%, transparent 76%);
            opacity:var(--pill-ref-opacity,0);transition:opacity 420ms ease, transform 260ms ease;filter:blur(8px);
        }
        .pill::after{z-index:2}
        .pill > span{position:relative;z-index:3}

        /* Clipboard capsule styles */
        .home-clipboard{position:relative;display:flex;flex-direction:column;align-items:center;width:min(1100px,92%);gap:10px;z-index:1;padding-bottom:24px}
        .home-clipboard.open{z-index:460}
        .home-clipboard .pill{width:100%;position:relative;padding-right:110px;padding-left:28px;padding-top:10px;padding-bottom:10px;border-radius:34px}
        .home-capsule{justify-content:center;gap:20px;cursor:default;transition:transform 0.5s cubic-bezier(.25,.85,.35,1),box-shadow 0.4s ease,border-color 0.25s ease;min-height:48px;outline:none;position:relative;z-index:2;box-shadow:0 12px 34px rgba(6,40,90,0.14);will-change:transform,box-shadow}
        .home-capsule span{color:#e6f5ff;font-size:clamp(15px,1.4vw,18px);font-weight:inherit}
        .home-clipboard-count{position:absolute;top:50%;right:12px;min-width:32px;height:22px;padding:0 12px;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;box-shadow:0 16px 36px rgba(11,99,199,0.32);transform:translateY(-50%) scale(0);opacity:0;transition:transform 0.3s ease,opacity 0.3s ease;pointer-events:none;z-index:4}
        .home-clipboard.has-items .home-clipboard-count{transform:translateY(-50%) scale(1);opacity:1}
        .home-clipboard.drag-ready{z-index:480}
        .home-clipboard.drag-ready .home-capsule{transform:scale(1.12);box-shadow:0 58px 120px rgba(6,40,90,0.26);border-color:rgba(255,255,255,0.32)}
        .home-clipboard.captured .home-capsule{animation:homeCapsuleSnap 0.6s cubic-bezier(.3,1.2,.3,1)}
        @keyframes homeCapsuleSnap{0%{transform:scale(1.08);}50%{transform:scale(0.96);}100%{transform:scale(1);}}
        .home-clipboard-panel{position:absolute;left:0;top:calc(100% - 10px);width:100%;background:linear-gradient(200deg, rgba(255,255,255,0.28), rgba(235,245,255,0.12));border:1px solid rgba(255,255,255,0.32);border-radius:30px;padding:0 24px;max-height:0;opacity:0;overflow:hidden;transition:max-height 0.45s cubic-bezier(.25,.9,.3,1),opacity 0.28s ease,padding 0.3s ease,transform 0.35s cubic-bezier(.3,.95,.4,1);pointer-events:none;backdrop-filter:blur(24px);box-shadow:0 44px 88px rgba(5,20,45,0.32);transform:translateY(-26px) scaleY(0.88);transform-origin:top center}
        .home-clipboard-panel::before{content:'';position:absolute;left:40px;right:40px;top:-28px;height:36px;border-radius:20px;background:linear-gradient(200deg, rgba(255,255,255,0.3), rgba(235,245,255,0.14));opacity:0;transform:translateY(12px);transition:opacity 0.32s ease,transform 0.32s cubic-bezier(.3,.95,.4,1);pointer-events:none}
        .home-clipboard.open .home-clipboard-panel{max-height:420px;opacity:1;padding:22px 24px 26px;pointer-events:auto;transform:translateY(0) scaleY(1);overflow:auto}
        .home-clipboard.open .home-clipboard-panel::before{opacity:1;transform:translateY(0)}
        .home-clipboard-empty{margin:0 0 12px;font-size:13px;color:rgba(230,245,255,0.82);text-align:center}
        .home-clipboard.has-items .home-clipboard-empty{display:none}
        .home-clipboard-list{list-style:none;margin:0;padding:0;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
        .home-clipboard-item{position:relative;display:flex;align-items:flex-start;gap:14px;padding:14px 16px;border-radius:18px;background:rgba(255,255,255,0.18);border:1px solid rgba(255,255,255,0.28);box-shadow:0 18px 42px rgba(5,20,45,0.18);cursor:grab;transition:transform 0.25s ease,box-shadow 0.25s ease,opacity 0.2s ease}
        .home-clipboard-item:hover{transform:translateY(-4px);box-shadow:0 24px 52px rgba(5,20,45,0.24)}
        .home-clipboard-preview{flex:0 0 64px;width:64px;height:64px;border-radius:14px;background:rgba(255,255,255,0.16);border:1px solid rgba(255,255,255,0.26);overflow:hidden;display:flex;align-items:center;justify-content:center;color:var(--accent-dark);text-align:center}
        .home-clipboard-preview img{width:100%;height:100%;object-fit:cover;display:block}
        .home-clipboard-preview-icon{font-size:24px}
        .home-clipboard-info{flex:1;display:flex;flex-direction:column;gap:6px;min-width:0}
        .home-clipboard-item-title{font-size:13px;font-weight:600;color:var(--accent-dark);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .home-clipboard-snippet{font-size:11px;line-height:1.35;color:var(--accent-dark);margin:0;overflow:hidden;display:-webkit-box;line-clamp:2;-webkit-line-clamp:2;-webkit-box-orient:vertical}
        .home-clipboard-item-details{font-size:10px;color:var(--text-sub);text-transform:uppercase;letter-spacing:0.5px}

        @media (max-width:640px){
            .topbar{gap:10px}
            .pill{min-width:160px;padding:clamp(8px,4vw,14px)}
            .home-capsule{flex-direction:column;align-items:center;gap:8px}
            .home-capsule span{text-align:center}
        }

        @media (prefers-reduced-motion: reduce){
            .home-capsule{transition:none}
            .home-clipboard-panel{transition:none;transform:none}
            .home-clipboard.drag-ready .home-capsule{transform:none;box-shadow:0 12px 34px rgba(6,40,90,0.14)}
            .home-clipboard.captured .home-capsule{animation:none}
        }
        
        /* Profile dropdown styles copied from homepage */
        .profile-container { position: relative; }

        .profile-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
        }

        .profile-icon:hover { transform: scale(1.07); }

        .profile-dropdown {
            position: absolute;
            right: 0;
            top: 58px;
            width: 220px;
            background: #fff;
            border-radius: 12px;
            padding: 10px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.22s ease;
            z-index: 999;
        }

        .profile-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        .dropdown-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .profile-dropdown ul {
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .profile-dropdown li a {
            display: block;
            padding: 12px 18px;
            font-size: 15px;
            color: #333;
            text-decoration: none;
            transition: 0.2s;
        }

        .profile-dropdown li a:hover {
            background: #f5f5f5;
            transform: translateX(3px);
        }

        .profile-dropdown .icon {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            opacity: 0.85;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .profile-dropdown .arrow {
            margin-left: auto;
            opacity: 0;
            transform: translateX(-6px);
            transition: 0.25s ease;
            font-size: 13px;
            color: #666;
        }

        .profile-dropdown ul li a:hover .arrow {
            opacity: 1;
            transform: translateX(0);
        }

        /* --- CONTAINER --- */
        .main-container { position: relative; z-index: 10; max-width: 1000px; margin: 0 auto; padding: 100px 20px; }
        .profile-grid { display: grid; grid-template-columns: 320px 1fr; gap: 30px; margin-top: 20px; }
        .glass-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 24px; padding: 35px; backdrop-filter: blur(30px); box-shadow: 0 15px 35px rgba(0,0,0,0.03); }

        /* --- AVATAR & CROPPER --- */
        .avatar-section { text-align: center; }
        .avatar-wrap { position: relative; width: 160px; height: 160px; margin: 0 auto 20px; }
        .profile-pic { width: 100%; height: 100%; border-radius: 40px; object-fit: cover; border: 5px solid white; box-shadow: 0 10px 25px rgba(0,0,0,0.06); }
        .upload-btn { position: absolute; bottom: -5px; right: -5px; background: white; border: 1px solid var(--border); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.08); z-index: 5; font-size: 16px; }

        /* Cropper Modal */
        #cropper-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 2000; align-items: center; justify-content: center; }
        .cropper-container { background: white; padding: 25px; border-radius: 30px; width: 90%; max-width: 450px; text-align: center; }
        
        /* --- FORM --- */
        .field { margin-bottom: 20px; }
        .field label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 8px; margin-left: 5px; }
        .field input, .field select { width: 100%; padding: 14px 18px; background: #fff; border: 1px solid rgba(0,0,0,0.1); border-radius: 14px; font-size: 16px; outline: none; transition: 0.3s; }
        .field input:focus { border-color: var(--theme-color); box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1); }
        .btn-save { width: 100%; padding: 16px; background: var(--theme-color); color: white; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; transition: 0.3s; }

        /* --- APPLE CALENDAR OVERRIDE --- */
        .flatpickr-calendar { border-radius: 20px !important; box-shadow: 0 15px 40px rgba(0,0,0,0.1) !important; border: none !important; padding: 10px; }
        .flatpickr-day.selected { background: var(--theme-color) !important; border-radius: 10px; }

        /* --- LOGOUT POPUP --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-card { background: white; padding: 30px; border-radius: 20px; width: 300px; text-align: center; }
        .sign-out-btn { margin-top: 40px; color: var(--danger); font-weight: 600; cursor: pointer; background: white; border: 1px solid rgba(255,43,48,0.1); padding: 12px 30px; border-radius: 12px; }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 12px 25px; background: #1d1d1f; color: white; border-radius: 50px; font-size: 14px; opacity: 0; transition: 0.4s; z-index: 3000; }
        .toast.show { opacity: 1; bottom: 50px; }

        /* Dark mode tweaks to match homepage */
        body.dark-mode {
            --text-main: #e5e7eb;
            --text-sub: rgba(226,232,240,0.68);
            --card-bg: rgba(15,23,42,0.86);
            --border: rgba(148,163,184,0.22);
            color: #e5e7eb;
            background:
                linear-gradient(180deg, rgba(15,23,42,0.96), rgba(15,23,42,0.92));
        }
        body.dark-mode nav { background: rgba(15,23,42,0.85); border-color: rgba(148,163,184,0.4); }
        body.dark-mode .glass-card { background: rgba(15,23,42,0.9); border-color: rgba(148,163,184,0.35); box-shadow: 0 18px 40px rgba(0,0,0,0.45); }
        body.dark-mode .field input,
        body.dark-mode .field select { background: rgba(15,23,42,0.9); border-color: rgba(55,65,81,0.9); color: #e5e7eb; }
        body.dark-mode .field label { color: #9ca3af; }
        body.dark-mode .btn-save { box-shadow: 0 10px 26px rgba(37,99,235,0.6); }

        body.dark-mode .profile-dropdown {
            background: rgba(15,23,42,0.92);
            border: 1px solid rgba(148,163,184,0.22);
            box-shadow: 0 18px 50px rgba(0,0,0,0.55);
        }
        body.dark-mode .dropdown-header { border-bottom-color: rgba(148,163,184,0.16); }
        body.dark-mode .profile-dropdown li a { color: rgba(226,232,240,0.92); }
        body.dark-mode .profile-dropdown li a:hover { background: rgba(148,163,184,0.12); }
        body.dark-mode .profile-dropdown .arrow { color: rgba(226,232,240,0.62); }

        body.dark-mode #cropper-modal { background: rgba(0,0,0,0.75); }
        body.dark-mode .cropper-container {
            background: linear-gradient(180deg, rgba(15,23,42,0.96), rgba(2,6,23,0.92));
            border: 1px solid rgba(148,163,184,0.22);
            color: rgba(226,232,240,0.92);
        }

        body.dark-mode .modal-overlay { background: rgba(0,0,0,0.62); }
        body.dark-mode .modal-card {
            background: linear-gradient(180deg, rgba(15,23,42,0.96), rgba(2,6,23,0.92));
            border: 1px solid rgba(148,163,184,0.22);
            color: rgba(226,232,240,0.92);
        }
        body.dark-mode .sign-out-btn {
            background: rgba(15,23,42,0.72);
            border-color: rgba(255,43,48,0.22);
        }

        /* Change password modal */
        .pw-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.45); backdrop-filter: blur(8px); z-index: 2200; display: none; align-items: center; justify-content: center; }
        .pw-card { width: 92%; max-width: 420px; background: white; border-radius: 22px; padding: 22px; box-shadow: 0 18px 50px rgba(0,0,0,0.18); border: 1px solid rgba(0,0,0,0.06); }
        .pw-card h3 { font-size: 18px; font-weight: 800; margin-bottom: 8px; }
        .pw-card p { font-size: 13px; color: var(--text-sub); margin-bottom: 14px; }
        .pw-row { display:flex; gap:10px; margin-top: 14px; }
        .pw-btn-secondary { flex:1; padding: 14px 16px; border-radius: 14px; border: 1px solid rgba(0,0,0,0.08); background: #f2f2f7; color: #111; font-weight: 700; cursor:pointer; }
        .pw-btn-primary { flex:1; padding: 14px 16px; border-radius: 14px; border: none; background: var(--theme-color); color: white; font-weight: 800; cursor:pointer; }
        .pw-btn-primary:disabled { opacity: 0.7; cursor: default; }
        .pw-field { margin-top: 12px; }
        .pw-field label { display:block; font-size: 12px; font-weight: 700; color: var(--text-sub); margin: 0 0 6px 5px; }
        .pw-field input { width: 100%; padding: 14px 18px; background: #fff; border: 1px solid rgba(0,0,0,0.1); border-radius: 14px; font-size: 15px; outline:none; }
        .pw-field input:focus { border-color: var(--theme-color); box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.12); }

        body.dark-mode .pw-modal { background: rgba(0,0,0,0.62); }
        body.dark-mode .pw-card {
            background: linear-gradient(180deg, rgba(15,23,42,0.96), rgba(2,6,23,0.92));
            border-color: rgba(148,163,184,0.22);
            color: rgba(226,232,240,0.92);
            box-shadow: 0 18px 60px rgba(0,0,0,0.62);
        }
        body.dark-mode .pw-card p { color: rgba(226,232,240,0.62); }
        body.dark-mode .pw-field label { color: rgba(226,232,240,0.62); }
        body.dark-mode .pw-field input { background: rgba(15,23,42,0.82); border-color: rgba(55,65,81,0.9); color: rgba(226,232,240,0.92); }
        body.dark-mode .pw-btn-secondary { background: rgba(30,41,59,0.72); border-color: rgba(148,163,184,0.22); color: rgba(226,232,240,0.92); }
    </style>
</head>
<body>

    <div class="background-blobs"></div>

    <div class="frame">
        <div class="topbar">
            <div class="icon-btn" title="Начало" onclick="window.location.href='homepage (3) (2).html'">
                <i class="fa-solid fa-house-chimney" style="color:#ffffff;"></i>
            </div>

            <div class="center-pill">
                <div class="home-clipboard" id="homeClipboard">
                    <div class="pill home-capsule" id="homeClipboardCapsule" role="button" tabindex="0" aria-expanded="false" aria-controls="homeClipboardPanel">
                        <span id="date">17.02.2026 г.</span>
                        <span id="time">10:29 PM</span>
                        <span class="home-clipboard-count" id="homeClipboardCount" aria-hidden="true">0</span>
                    </div>
                    <div class="home-clipboard-panel" id="homeClipboardPanel" aria-hidden="true">
                        <p class="home-clipboard-empty" id="homeClipboardEmpty">Плъзни файлове върху капсулата, за да ги запазиш временно.</p>
                        <ul class="home-clipboard-list" id="homeClipboardList"></ul>
                    </div>
                </div>
            </div>

            <div class="profile-container">
                <img src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22128%22%20height%3D%22128%22%20viewBox%3D%220%200%20128%20128%22%3E%3Cdefs%3E%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20x2%3D%221%22%20y1%3D%220%22%20y2%3D%221%22%3E%3Cstop%20stop-color%3D%22%23009fe6%22%2F%3E%3Cstop%20offset%3D%221%22%20stop-color%3D%22%230b63c7%22%2F%3E%3C%2FlinearGradient%3E%3C%2Fdefs%3E%3Ccircle%20cx%3D%2264%22%20cy%3D%2264%22%20r%3D%2264%22%20fill%3D%22url%28%23g%29%22%2F%3E%3Ccircle%20cx%3D%2264%22%20cy%3D%2250%22%20r%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.92%29%22%2F%3E%3Cpath%20d%3D%22M24%20118c9-20%2027-32%2040-32s31%2012%2040%2032%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.92%29%22%2F%3E%3C%2Fsvg%3E" id="profileBtn" class="profile-icon" alt="Profile">

                <div class="profile-dropdown" id="profileDropdown">
                    <div class="dropdown-header">
                        <img src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22128%22%20height%3D%22128%22%20viewBox%3D%220%200%20128%20128%22%3E%3Cdefs%3E%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20x2%3D%221%22%20y1%3D%220%22%20y2%3D%221%22%3E%3Cstop%20stop-color%3D%22%23009fe6%22%2F%3E%3Cstop%20offset%3D%221%22%20stop-color%3D%22%230b63c7%22%2F%3E%3C%2FlinearGradient%3E%3C%2Fdefs%3E%3Ccircle%20cx%3D%2264%22%20cy%3D%2264%22%20r%3D%2264%22%20fill%3D%22url%28%23g%29%22%2F%3E%3Ccircle%20cx%3D%2264%22%20cy%3D%2250%22%20r%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.92%29%22%2F%3E%3Cpath%20d%3D%22M24%20118c9-20%2027-32%2040-32s31%2012%2040%2032%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.92%29%22%2F%3E%3C%2Fsvg%3E" class="dropdown-avatar" alt="Avatar">
                        <h4 data-i18n="menu.profileTitle">Твоят профил</h4>
                    </div>

                    <ul>
                        <li>
                            <a href="account (1).html">
                                <i class="fa-solid fa-user-pen icon" aria-hidden="true"></i>
                                <span data-i18n="menu.editProfile">Редактирай профил</span>
                                <span class="arrow">▶</span>
                            </a>
                        </li>
                        <li>
                            <a href="homepage (3) (2).html">
                                <i class="fa-solid fa-house-chimney icon" aria-hidden="true"></i>
                                <span data-i18n="menu.home">Начало</span>
                                <span class="arrow">▶</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="signOut(); return false;">
                                <i class="fa-solid fa-right-from-bracket icon" aria-hidden="true"></i>
                                <span data-i18n="menu.logout">Изход</span>
                                <span class="arrow">▶</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="main-container">
        <div class="profile-grid">
            <aside class="glass-card avatar-section">
                <div class="avatar-wrap">
                    <img id="profile-img" src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22128%22%20height%3D%22128%22%20viewBox%3D%220%200%20128%20128%22%3E%3Cdefs%3E%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20x2%3D%221%22%20y1%3D%220%22%20y2%3D%221%22%3E%3Cstop%20stop-color%3D%22%23009fe6%22%2F%3E%3Cstop%20offset%3D%221%22%20stop-color%3D%22%230b63c7%22%2F%3E%3C%2FlinearGradient%3E%3C%2Fdefs%3E%3Ccircle%20cx%3D%2264%22%20cy%3D%2264%22%20r%3D%2264%22%20fill%3D%22url%28%23g%29%22%2F%3E%3Ccircle%20cx%3D%2264%22%20cy%3D%2250%22%20r%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.92%29%22%2F%3E%3Cpath%20d%3D%22M24%20118c9-20%2027-32%2040-32s31%2012%2040%2032%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.92%29%22%2F%3E%3C%2Fsvg%3E" class="profile-pic" alt="Профил">
                    <label class="upload-btn" aria-label="Качи снимка">
                        <i class="fa-solid fa-camera"></i>
                        <input type="file" id="avatar-input" hidden accept="image/*">
                    </label>
                </div>
                <h2 id="display-name" style="font-size: 20px;">Потребител</h2>
                <p id="display-email" style="font-size: 13px; color: var(--text-sub);"></p>
            </aside>

            <main class="glass-card">
                <form id="profile-form">
                    <div class="field"><label data-i18n="profile.email">Имейл</label><input type="email" id="email" readonly></div>
                    <div class="field"><label data-i18n="profile.fullName">Пълно име</label><input type="text" id="full_name" placeholder="Твоето име"></div>
                    <div class="field"><label data-i18n="profile.birthday">Дата на раждане</label><input type="text" id="birthday" placeholder="Избери дата"></div>
                    <div class="field"><label data-i18n="profile.location">Град / Държава</label><input type="text" id="location" placeholder="София, България"></div>
                    <div class="field">
                        <label data-i18n="profile.language">Език</label>
                        <select id="language"><option value="bg">Български</option><option value="en">English</option></select>
                    </div>
                    <button type="submit" class="btn-save" data-i18n="profile.save">Запази промените</button>
                </form>

                <div style="margin-top:14px; display:flex; gap:10px;">
                    <button type="button" class="btn-save" id="changePwBtn" style="background:#f2f2f7; color:black" data-i18n="profile.changePassword">Смени парола</button>
                </div>
            </main>
        </div>

        <div style="text-align:center"><button class="sign-out-btn" onclick="toggleLogoutModal(true)" data-i18n="profile.signOut">Изход от акаунта</button></div>
    </div>

    <div id="cropper-modal">
        <div class="cropper-container">
            <h3 style="margin-bottom:15px">Редактирай снимката</h3>
            <div id="cropper-viewport"></div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-save" style="background:#f2f2f7; color:black;" onclick="closeCropper()">Отказ</button>
                <button class="btn-save" id="crop-result">Запази снимката</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="logoutModal">
        <div class="modal-card">
            <h3>Изход?</h3>
            <p style="margin: 15px 0; font-size:14px; color:var(--text-sub)">Сигурни ли сте?</p>
            <button class="btn-save" style="background:var(--danger); margin-bottom:10px" onclick="signOut()">Да, излез</button>
            <button class="btn-save" style="background:#f2f2f7; color:black" onclick="toggleLogoutModal(false)">Отказ</button>
        </div>
    </div>

    <div id="toast" class="toast">Запазено!</div>

    <div class="pw-modal" id="pwModal" onclick="if(event.target === this) togglePwModal(false)">
        <div class="pw-card">
            <h3 data-i18n="pw.title">Смяна на парола</h3>
            <p data-i18n="pw.subtitle">За сигурност въведи текущата парола и избери нова.</p>

            <div class="pw-field">
                <label for="pwCurrent" data-i18n="pw.current">Текуща парола</label>
                <input id="pwCurrent" type="password" autocomplete="current-password" placeholder="••••••••" />
            </div>
            <div class="pw-field">
                <label for="pwNew" data-i18n="pw.new">Нова парола</label>
                <input id="pwNew" type="password" autocomplete="new-password" placeholder="Минимум 8 символа" />
            </div>
            <div class="pw-field">
                <label for="pwNew2" data-i18n="pw.repeat">Повтори новата парола</label>
                <input id="pwNew2" type="password" autocomplete="new-password" placeholder="Повтори паролата" />
            </div>

            <div class="pw-row">
                <button type="button" class="pw-btn-secondary" onclick="togglePwModal(false)" data-i18n="common.cancel">Отказ</button>
                <button type="button" class="pw-btn-primary" id="pwSaveBtn" onclick="changePassword()" data-i18n="common.save">Запази</button>
            </div>
        </div>
    </div>

    <script>
        // Apply shared StudySpace theme based on saved settings
        (function(){
            const DEFAULT = { accentColor:'#2f6bff', darkMode:false, sound:true, sfx:true };
            let s = { ...DEFAULT };
            function hexToRgbaStart(hex){
                if (!hex || hex[0] !== '#' || (hex.length !== 7 && hex.length !== 4)) return 'rgba(32, 102, 255, 0.72)';
                let r,g,b;
                if (hex.length === 7) {
                    r = parseInt(hex.slice(1,3),16);
                    g = parseInt(hex.slice(3,5),16);
                    b = parseInt(hex.slice(5,7),16);
                } else {
                    r = parseInt(hex[1] + hex[1],16);
                    g = parseInt(hex[2] + hex[2],16);
                    b = parseInt(hex[3] + hex[3],16);
                }
                return `rgba(${r}, ${g}, ${b}, 0.72)`;
            }
            try {
                const raw = localStorage.getItem('studyspace_settings');
                if (raw) s = { ...s, ...JSON.parse(raw) };
            } catch(e) {}
            const root = document.documentElement;
            const accent = s.accentColor || DEFAULT.accentColor;
            root.style.setProperty('--accent', accent);
            root.style.setProperty('--accent-2', accent);
            root.style.setProperty('--grad-start', hexToRgbaStart(accent));
            document.body.classList.toggle('dark-mode', !!s.darkMode);
            window.studyspaceSettings = { soundEnabled: !!s.sound, sfxEnabled: !!s.sfx };
        })();

        // Persist language selection across all pages
        (function(){
            const LANG_KEY = 'studyspace_language';
            const FALLBACK = 'bg';
            function normalize(v){
                const x = String(v || '').toLowerCase();
                return (x === 'en') ? 'en' : 'bg';
            }
            function getLang(){
                try{ return normalize(localStorage.getItem(LANG_KEY) || FALLBACK); }catch(e){ return FALLBACK; }
            }
            function setLang(v){
                const norm = normalize(v);
                try{ localStorage.setItem(LANG_KEY, norm); }catch(e){}
                document.documentElement.setAttribute('lang', norm);
                applyI18n();
                return norm;
            }

            const DICT = {
                bg: {
                    'menu.profileTitle': 'Твоят профил',
                    'menu.editProfile': 'Редактирай профил',
                    'menu.home': 'Начало',
                    'menu.logout': 'Изход',
                    'profile.email': 'Имейл',
                    'profile.fullName': 'Пълно име',
                    'profile.birthday': 'Дата на раждане',
                    'profile.location': 'Град / Държава',
                    'profile.language': 'Език',
                    'profile.save': 'Запази промените',
                    'profile.changePassword': 'Смени парола',
                    'profile.signOut': 'Изход от акаунта',
                    'pw.title': 'Смяна на парола',
                    'pw.subtitle': 'За сигурност въведи текущата парола и избери нова.',
                    'pw.current': 'Текуща парола',
                    'pw.new': 'Нова парола',
                    'pw.repeat': 'Повтори новата парола',
                    'common.cancel': 'Отказ',
                    'common.save': 'Запази'
                },
                en: {
                    'menu.profileTitle': 'Your profile',
                    'menu.editProfile': 'Edit profile',
                    'menu.home': 'Home',
                    'menu.logout': 'Logout',
                    'profile.email': 'Email',
                    'profile.fullName': 'Full name',
                    'profile.birthday': 'Birthday',
                    'profile.location': 'City / Country',
                    'profile.language': 'Language',
                    'profile.save': 'Save changes',
                    'profile.changePassword': 'Change password',
                    'profile.signOut': 'Sign out',
                    'pw.title': 'Change password',
                    'pw.subtitle': 'For security, enter your current password and choose a new one.',
                    'pw.current': 'Current password',
                    'pw.new': 'New password',
                    'pw.repeat': 'Repeat new password',
                    'common.cancel': 'Cancel',
                    'common.save': 'Save'
                }
            };

            function applyI18n(){
                const lang = getLang();
                const t = DICT[lang] || DICT[FALLBACK] || {};
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if(key && t[key]) el.textContent = t[key];
                });
            }
            window.studyspaceI18n = window.studyspaceI18n || {};
            window.studyspaceI18n.getLang = getLang;
            window.studyspaceI18n.setLang = setLang;
            window.studyspaceI18n.localeForLang = (lang) => (lang === 'en' ? 'en-GB' : 'bg-BG');
            window.studyspaceI18n.apply = applyI18n;
            setLang(getLang());
        })();

    </script>

    <script>
        // Read Supabase config from meta tags (preferred) or fall back to hardcoded values
        const SUPABASE_URL = document.querySelector('meta[name="supabase-url"]')?.content || 'https://zfqpfhtbpfdudbpqzbbg.supabase.co';
        const SUPABASE_KEY = document.querySelector('meta[name="supabase-key"]')?.content || 'sb_publishable_-pHOflGGasRf4o18KIXXQg_OPRhB6gK';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Cached DOM nodes
        const profileImg = document.getElementById('profile-img');
        const avatarInput = document.getElementById('avatar-input');
        const cropperModal = document.getElementById('cropper-modal');
        const cropperViewport = document.getElementById('cropper-viewport');
        const displayName = document.getElementById('display-name');
        const displayEmail = document.getElementById('display-email');
        const fullNameInput = document.getElementById('full_name');
        const birthdayInput = document.getElementById('birthday');
        const locationInput = document.getElementById('location');
        const languageSelect = document.getElementById('language');
        const profileForm = document.getElementById('profile-form');
        const toastEl = document.getElementById('toast');
        const logoutModal = document.getElementById('logoutModal');

        let croppieInstance = null;
        let flatpickrInstance = null;
        let currentUser = null;
        let toastTimer = null;

        const DEFAULT_AVATAR = 'data:image/svg+xml,' + encodeURIComponent(
            '<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><defs><radialGradient id="bg" cx="0.3" cy="0.2" r="0.8"><stop offset="0%" stop-color="#e7f3ff"/><stop offset="55%" stop-color="#c7ddff"/><stop offset="100%" stop-color="#a9c7ff"/></radialGradient></defs><circle cx="80" cy="80" r="76" fill="url(#bg)"/><circle cx="80" cy="64" r="28" fill="#fdfefe"/><path d="M34 132c8-22 25-36 46-36s38 14 46 36" fill="#fdfefe"/></svg>'
        );
        profileImg.src = DEFAULT_AVATAR;
        profileImg.onerror = () => { profileImg.src = DEFAULT_AVATAR; };

        // Initialize flatpickr and keep the instance for later
        flatpickrInstance = flatpickr(birthdayInput, { dateFormat: 'Y-m-d', locale: 'bg' });

        async function getCurrentUser() {
            if (currentUser) return currentUser;
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                currentUser = user;
                return user;
            } catch (err) {
                console.error('getUser failed', err);
                return null;
            }
        }

        async function loadProfile() {
            try {
                const user = await getCurrentUser();
                if (!user) { window.location.href = 'login.html'; return; }

                profileForm.querySelector('#email').value = user.email || '';
                displayEmail.innerText = user.email || '';

                const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
                if (error && error.code !== 'PGRST116') console.warn('profiles select error', error);
                if (data) {
                    fullNameInput.value = data.full_name || '';
                    displayName.innerText = data.full_name || 'Потребител';
                    locationInput.value = data.location || '';
                    languageSelect.value = data.language || 'bg';
                    if(window.studyspaceI18n && typeof window.studyspaceI18n.setLang === 'function'){
                        window.studyspaceI18n.setLang(languageSelect.value);
                    } else {
                        try{ localStorage.setItem('studyspace_language', languageSelect.value); }catch(e){}
                    }
                    if (data.birthday && flatpickrInstance) flatpickrInstance.setDate(data.birthday, true);
                    if (data.avatar_url) profileImg.src = data.avatar_url;
                    else profileImg.src = DEFAULT_AVATAR;
                }
            } catch (err) {
                console.error('loadProfile error', err);
                showToast('Грешка при зареждане на профила');
            }
        }

        function persistLanguage(lang){
            if(window.studyspaceI18n && typeof window.studyspaceI18n.setLang === 'function'){
                window.studyspaceI18n.setLang(lang);
            } else {
                try{ localStorage.setItem('studyspace_language', lang); }catch(e){}
                document.documentElement.setAttribute('lang', String(lang || 'bg'));
            }
        }

        // Save profile changes
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const user = await getCurrentUser();
                if (!user) return showToast('Не сте вписани');

                const updates = {
                    id: user.id,
                    full_name: fullNameInput.value,
                    birthday: birthdayInput.value,
                    location: locationInput.value,
                    language: languageSelect.value,
                    updated_at: new Date().toISOString(),
                };

                const { error } = await supabaseClient.from('profiles').upsert(updates);
                if (error) {
                    console.error('upsert error', error);
                    showToast('Грешка при запазване');
                } else {
                    persistLanguage(languageSelect.value);
                    showToast('Профилът е обновен!');
                }
            } catch (err) {
                console.error('save profile failed', err);
                showToast('Грешка при запазване');
            }
        });

        if(languageSelect){
            // Apply stored language early (before profile loads)
            try{
                const stored = localStorage.getItem('studyspace_language');
                if(stored) languageSelect.value = stored;
            }catch(e){}
            languageSelect.addEventListener('change', async () => {
                persistLanguage(languageSelect.value);
                try{
                    const user = await getCurrentUser();
                    if(user){
                        await supabaseClient.from('profiles').upsert({
                            id: user.id,
                            language: languageSelect.value,
                            updated_at: new Date().toISOString()
                        });
                    }
                }catch(err){
                    console.warn('language upsert failed', err);
                }
                showToast('Езикът е обновен');
            });
        }

        // Change password modal + logic
        const pwModal = document.getElementById('pwModal');
        const changePwBtn = document.getElementById('changePwBtn');
        const pwSaveBtn = document.getElementById('pwSaveBtn');
        const pwCurrent = document.getElementById('pwCurrent');
        const pwNew = document.getElementById('pwNew');
        const pwNew2 = document.getElementById('pwNew2');

        function togglePwModal(show){
            if(!pwModal) return;
            pwModal.style.display = show ? 'flex' : 'none';
            if(show){
                setTimeout(() => { try{ pwCurrent && pwCurrent.focus(); }catch(e){} }, 0);
            } else {
                if(pwCurrent) pwCurrent.value = '';
                if(pwNew) pwNew.value = '';
                if(pwNew2) pwNew2.value = '';
                if(pwSaveBtn) pwSaveBtn.disabled = false;
            }
        }
        window.togglePwModal = togglePwModal;

        if(changePwBtn){
            changePwBtn.addEventListener('click', () => togglePwModal(true));
        }

        async function changePassword(){
            const current = (pwCurrent && pwCurrent.value) ? pwCurrent.value : '';
            const next = (pwNew && pwNew.value) ? pwNew.value : '';
            const next2 = (pwNew2 && pwNew2.value) ? pwNew2.value : '';

            if(next.length < 8){
                showToast('Новата парола трябва да е поне 8 символа');
                return;
            }
            if(next !== next2){
                showToast('Двете нови пароли не съвпадат');
                return;
            }

            try{
                if(pwSaveBtn) pwSaveBtn.disabled = true;
                const user = await getCurrentUser();
                if(!user || !user.email){
                    showToast('Не сте вписани');
                    return;
                }

                // Re-authenticate to validate current password (password users)
                const { error: signErr } = await supabaseClient.auth.signInWithPassword({
                    email: user.email,
                    password: current
                });
                if(signErr){
                    console.warn('reauth failed', signErr);
                    showToast('Грешна текуща парола или нужда от повторно вписване');
                    return;
                }

                const { error: updErr } = await supabaseClient.auth.updateUser({ password: next });
                if(updErr){
                    console.error('update password failed', updErr);
                    showToast('Неуспешна смяна на парола');
                    return;
                }

                showToast('Паролата е сменена');
                togglePwModal(false);
            }catch(err){
                console.error('changePassword failed', err);
                showToast('Грешка при смяна на парола');
            }finally{
                if(pwSaveBtn) pwSaveBtn.disabled = false;
            }
        }
        window.changePassword = changePassword;

        // Image Cropping: open modal & init Croppie
        avatarInput.addEventListener('change', function () {
            const file = this.files && this.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (ev) {
                cropperModal.style.display = 'flex';
                if (croppieInstance) {
                    try { croppieInstance.destroy(); } catch (e) { /* ignore */ }
                    croppieInstance = null;
                }

                croppieInstance = new Croppie(cropperViewport, {
                    viewport: { width: 200, height: 200, type: 'square' },
                    boundary: { width: 300, height: 300 },
                    showZoomer: true
                });
                croppieInstance.bind({ url: ev.target.result });
            };
            reader.readAsDataURL(file);
        });

        // Crop & upload
        document.getElementById('crop-result').addEventListener('click', async () => {
            if (!croppieInstance) return showToast('Няма изображение за запазване');
            try {
                const blob = await croppieInstance.result({ type: 'blob', size: 'viewport', format: 'jpeg' });
                const user = await getCurrentUser();
                if (!user) return showToast('Не сте вписани');

                const fileName = `avatars/${user.id}-${Date.now()}.jpg`;

                const { error: upErr } = await supabaseClient.storage.from('avatars').upload(fileName, blob, { contentType: 'image/jpeg' });
                if (upErr) { console.error('upload err', upErr); return showToast('Грешка при качване'); }

                const { data } = supabaseClient.storage.from('avatars').getPublicUrl(fileName);
                if (data?.publicUrl) {
                    // Записваме/създаваме ред в profiles с avatar_url,
                    // за да може началната страница да го прочете.
                    const { error: profErr } = await supabaseClient
                        .from('profiles')
                        .upsert({
                            id: user.id,
                            avatar_url: data.publicUrl,
                            updated_at: new Date().toISOString()
                        });

                    if (profErr) console.warn('profiles upsert avatar_url error', profErr);

                    profileImg.src = data.publicUrl;
                    closeCropper();
                    showToast('Снимката е обновена!');
                } else {
                    showToast('Неуспешен публичен URL');
                }
            } catch (err) {
                console.error('crop upload failed', err);
                showToast('Грешка при качване');
            }
        });

        function closeCropper() { cropperModal.style.display = 'none'; }
        function toggleLogoutModal(s) { logoutModal.style.display = s ? 'flex' : 'none'; }

        function showToast(m) {
            toastEl.innerText = m;
            toastEl.classList.add('show');
            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => toastEl.classList.remove('show'), 3000);
        }

        async function signOut() {
            try {
                await supabaseClient.auth.signOut();
            } catch (err) {
                console.warn('signOut error', err);
            }
            window.location.href = 'login.html';
        }

        // Account Dropdown Toggle for top-right avatar
        const topProfileBtn = document.getElementById("profileBtn");
        const profileDropdown = document.getElementById("profileDropdown");

        if (topProfileBtn && profileDropdown) {
            topProfileBtn.addEventListener("click", () => {
                profileDropdown.classList.toggle("show");
            });

            document.addEventListener("click", (e) => {
                if (!topProfileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove("show");
                }
            });
        }

        function updateDateTime(){
            const d = new Date();
            const dateEl = document.getElementById('date');
            const timeEl = document.getElementById('time');
            const lang = (window.studyspaceI18n && window.studyspaceI18n.getLang) ? window.studyspaceI18n.getLang() : 'bg';
            const locale = (window.studyspaceI18n && window.studyspaceI18n.localeForLang) ? window.studyspaceI18n.localeForLang(lang) : 'bg-BG';
            if(dateEl) dateEl.textContent = d.toLocaleDateString(locale);
            if(timeEl) timeEl.textContent = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }
        updateDateTime();
        setInterval(updateDateTime, 60000);

        // Expose small helpers for existing inline attributes (keeps backward compatibility)
        window.toggleLogoutModal = toggleLogoutModal;
        window.closeCropper = closeCropper;
        window.signOut = signOut;

        // Kick off
        loadProfile();
    </script>

    <!-- Clipboard behavior copied from homepage -->
    <script>
        (async function(){
            const clipboard = document.getElementById('homeClipboard');
            const capsule = document.getElementById('homeClipboardCapsule');
            const panel = document.getElementById('homeClipboardPanel');
            const list = document.getElementById('homeClipboardList');
            const countEl = document.getElementById('homeClipboardCount');
            const emptyEl = document.getElementById('homeClipboardEmpty');
            if(!clipboard || !capsule || !panel || !list) return;

            const reducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            const clipboardElementMap = new Map();
            const TEXT_SNIPPET_TYPES = new Set([
                'application/json',
                'application/xml',
                'application/javascript',
                'application/x-javascript',
                'application/svg+xml'
            ]);
            const MAX_TEXT_PREVIEW_CHARS = 160;
            let clipboardItems = [];
            let clipboardOpen = false;
            let dragDepth = 0;
            let dragGhostEl = null;

            const STUDY_CLIPBOARD_DB_NAME = 'studyspace_clipboard_db_v1';
            const STUDY_CLIPBOARD_STORE = 'files';

            function openStudyClipboardDb(){
                if(!('indexedDB' in window)){
                    return Promise.reject(new Error('IndexedDB unavailable'));
                }
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(STUDY_CLIPBOARD_DB_NAME, 1);
                    request.onupgradeneeded = () => {
                        const db = request.result;
                        if(!db.objectStoreNames.contains(STUDY_CLIPBOARD_STORE)){
                            db.createObjectStore(STUDY_CLIPBOARD_STORE, { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error || new Error('IndexedDB open failed'));
                });
            }

            async function persistClipboardItem(item){
                if(!item || !item.id || !item.file) return;
                try{
                    const db = await openStudyClipboardDb();
                    await new Promise((resolve, reject) => {
                        const tx = db.transaction(STUDY_CLIPBOARD_STORE, 'readwrite');
                        tx.oncomplete = () => resolve();
                        tx.onerror = () => reject(tx.error || new Error('IndexedDB transaction failed'));
                        const store = tx.objectStore(STUDY_CLIPBOARD_STORE);
                        store.put({
                            id: item.id,
                            name: item.name,
                            size: item.size,
                            type: item.type || '',
                            lastModified: item.file.lastModified || Date.now(),
                            createdAt: item.createdAt || Date.now(),
                            blob: item.file
                        });
                    });
                } catch(err){
                    // Ignore persistence errors
                }
            }

            async function loadPersistedClipboardItems(){
                try{
                    const db = await openStudyClipboardDb();
                    const records = await new Promise((resolve, reject) => {
                        const tx = db.transaction(STUDY_CLIPBOARD_STORE, 'readonly');
                        const store = tx.objectStore(STUDY_CLIPBOARD_STORE);
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => reject(request.error || new Error('IndexedDB getAll failed'));
                    });
                    return (records || []).map(rec => {
                        const blob = rec && rec.blob;
                        const fallbackName = (rec && rec.name) || (blob && blob.name) || 'file';
                        const fallbackType = (rec && rec.type) || (blob && blob.type) || '';
                        const fallbackLastModified = (rec && rec.lastModified) || (blob && blob.lastModified) || Date.now();
                        const file = new File([blob], fallbackName, { type: fallbackType, lastModified: fallbackLastModified });
                        const mime = rec && rec.type ? rec.type : (file.type || '');
                        return {
                            id: rec.id,
                            name: rec.name || file.name,
                            size: rec.size || file.size,
                            type: mime,
                            displayType: mime || 'Файл',
                            file,
                            previewUrl: null,
                            previewKind: null,
                            previewIcon: null,
                            snippet: '',
                            previewPrepared: false,
                            createdAt: rec.createdAt || 0
                        };
                    }).filter(Boolean);
                } catch(err){
                    return [];
                }
            }

            async function syncClipboardFromDb(){
                try{
                    const persisted = await loadPersistedClipboardItems();
                    if(Array.isArray(persisted) && persisted.length > 0){
                        const existingById = new Map(clipboardItems.map(item => [item.id, item]));
                        persisted.forEach(item => {
                            if(item && item.id && !existingById.has(item.id)){
                                clipboardItems.push(item);
                            }
                        });
                        clipboardItems.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                    }
                } catch(err){
                    // Ignore sync errors
                }
                updateClipboardUI();
            }

            function formatBytes(bytes){
                if(typeof bytes !== 'number' || Number.isNaN(bytes)) return '0 B';
                const units = ['B','KB','MB','GB','TB'];
                let value = bytes;
                let index = 0;
                while(value >= 1024 && index < units.length - 1){
                    value /= 1024;
                    index++;
                }
                const formatted = value % 1 === 0 ? value : value.toFixed(1);
                return `${formatted} ${units[index]}`;
            }

            function pickPreviewIcon(type){
                if(!type) return '📄';
                if(type.includes('sheet') || type.includes('excel') || type.includes('spreadsheet')) return '📊';
                if(type.includes('presentation') || type.includes('powerpoint') || type.includes('slideshow')) return '📽️';
                if(type.includes('word') || type.includes('document') || type.includes('msword')) return '📃';
                if(type.includes('audio')) return '🎵';
                if(type.includes('video')) return '🎬';
                if(type.includes('pdf')) return '📕';
                if(type.includes('zip') || type.includes('compressed') || type.includes('archive')) return '🗜️';
                return '📄';
            }

            function fillPreview(previewEl, item){
                previewEl.innerHTML = '';
                if(item.previewKind === 'image' && item.previewUrl){
                    const img = document.createElement('img');
                    img.src = item.previewUrl;
                    img.alt = item.name;
                    previewEl.appendChild(img);
                } else {
                    const iconEl = document.createElement('div');
                    iconEl.className = 'home-clipboard-preview-icon';
                    iconEl.textContent = item.previewIcon || pickPreviewIcon((item.type || '').toLowerCase());
                    previewEl.appendChild(iconEl);
                }
            }

            function refreshItemPreview(item){
                const record = clipboardElementMap.get(item.id);
                if(record){
                    fillPreview(record.preview, item);
                }
            }

            function updateSnippetDisplay(item){
                const record = clipboardElementMap.get(item.id);
                if(!record) return;
                if(item.snippet){
                    if(record.snippet){
                        record.snippet.textContent = item.snippet;
                    } else {
                        const snippetEl = document.createElement('p');
                        snippetEl.className = 'home-clipboard-snippet';
                        snippetEl.textContent = item.snippet;
                        record.info.insertBefore(snippetEl, record.details);
                        record.snippet = snippetEl;
                    }
                } else if(record.snippet){
                    record.snippet.remove();
                    record.snippet = null;
                }
            }

            function prepareItemPreview(item){
                if(!item || !item.file || item.previewPrepared) return;
                const mime = (item.type || item.file.type || '').toLowerCase();
                if(mime.startsWith('image/')){
                    item.previewKind = 'image';
                    if(!item.previewUrl){
                        item.previewUrl = URL.createObjectURL(item.file);
                    }
                    refreshItemPreview(item);
                } else if(mime.startsWith('text/') || TEXT_SNIPPET_TYPES.has(mime)){
                    item.previewKind = 'icon';
                    item.previewIcon = '📝';
                    refreshItemPreview(item);
                    const snippetSource = item.file.slice(0, 4096);
                    snippetSource.text().then(text => {
                        if(typeof text !== 'string'){
                            item.previewKind = 'icon';
                            item.previewIcon = pickPreviewIcon(mime);
                            refreshItemPreview(item);
                            item.snippet = '';
                            updateSnippetDisplay(item);
                            return;
                        }
                        const cleaned = text.replace(/\s+/g,' ').trim();
                        if(!cleaned){
                            item.previewKind = 'icon';
                            item.previewIcon = pickPreviewIcon(mime);
                            refreshItemPreview(item);
                            item.snippet = '';
                            updateSnippetDisplay(item);
                            return;
                        }
                        item.snippet = cleaned.slice(0, MAX_TEXT_PREVIEW_CHARS);
                        if(cleaned.length > MAX_TEXT_PREVIEW_CHARS){
                            item.snippet = `${item.snippet}…`;
                        }
                        updateSnippetDisplay(item);
                        refreshItemPreview(item);
                    }).catch(()=>{
                        item.previewKind = 'icon';
                        item.previewIcon = pickPreviewIcon(mime);
                        refreshItemPreview(item);
                        item.snippet = '';
                        updateSnippetDisplay(item);
                    });
                } else {
                    item.previewKind = 'icon';
                    item.previewIcon = pickPreviewIcon(mime);
                    refreshItemPreview(item);
                }
                item.previewPrepared = true;
            }

            function createDragGhost(entry){
                const ghost = entry.cloneNode(true);
                ghost.style.position = 'absolute';
                ghost.style.top = '-9999px';
                ghost.style.left = '-9999px';
                ghost.style.pointerEvents = 'none';
                ghost.style.width = `${entry.offsetWidth}px`;
                document.body.appendChild(ghost);
                return ghost;
            }

            function handleItemDragStart(event, item, entry){
                entry.classList.add('dragging');
                if(event.dataTransfer){
                    event.dataTransfer.effectAllowed = 'copy';
                    event.dataTransfer.setData('text/plain', item.name);
                    event.dataTransfer.setData('application/x-studyspace-clipboard-id', item.id);
                    try{
                        event.dataTransfer.setData('application/x-study-clipboard', JSON.stringify({ name: item.name, size: item.size, type: item.displayType || 'Файл', mime: item.type || '' }));
                    } catch(err){}
                    if(event.dataTransfer.items && typeof event.dataTransfer.items.add === 'function' && item.file){
                        try{ event.dataTransfer.items.add(item.file); } catch(err){}
                    }
                    const ghost = createDragGhost(entry);
                    if(ghost){
                        dragGhostEl = ghost;
                        event.dataTransfer.setDragImage(ghost, ghost.offsetWidth / 2, ghost.offsetHeight / 2);
                    }
                }
            }

            function handleItemDragEnd(event){
                event.currentTarget.classList.remove('dragging');
                if(dragGhostEl && dragGhostEl.parentNode){
                    dragGhostEl.parentNode.removeChild(dragGhostEl);
                }
                dragGhostEl = null;
            }

            function createClipboardEntry(item){
                const entry = document.createElement('li');
                entry.className = 'home-clipboard-item';
                entry.setAttribute('draggable', 'true');
                entry.dataset.itemId = item.id;

                const preview = document.createElement('div');
                preview.className = 'home-clipboard-preview';
                fillPreview(preview, item);

                const title = document.createElement('div');
                title.className = 'home-clipboard-item-title';
                title.textContent = item.name;

                const info = document.createElement('div');
                info.className = 'home-clipboard-info';
                info.appendChild(title);

                let snippetEl = null;
                if(item.snippet){
                    snippetEl = document.createElement('p');
                    snippetEl.className = 'home-clipboard-snippet';
                    snippetEl.textContent = item.snippet;
                    info.appendChild(snippetEl);
                }

                const details = document.createElement('div');
                details.className = 'home-clipboard-item-details';
                details.textContent = `${item.displayType || 'Файл'} · ${formatBytes(item.size)}`;
                info.appendChild(details);

                entry.append(preview, info);
                entry.addEventListener('dragstart', (event) => handleItemDragStart(event, item, entry));
                entry.addEventListener('dragend', handleItemDragEnd);

                clipboardElementMap.set(item.id, { entry, preview, info, details, snippet: snippetEl });
                return entry;
            }

            function clearClipboardPreviews(){
                clipboardItems.forEach(item => {
                    if(item.previewUrl){
                        URL.revokeObjectURL(item.previewUrl);
                        item.previewUrl = null;
                    }
                });
            }

            function updateClipboardUI(){
                if(countEl){
                    countEl.textContent = clipboardItems.length.toString();
                    countEl.setAttribute('aria-hidden', clipboardItems.length > 0 ? 'false' : 'true');
                }
                clipboard.classList.toggle('has-items', clipboardItems.length > 0);
                if(emptyEl){
                    emptyEl.setAttribute('aria-hidden', clipboardItems.length > 0 ? 'true' : 'false');
                }
                clipboardElementMap.clear();
                list.innerHTML = '';
                clipboardItems.forEach(item => {
                    prepareItemPreview(item);
                    const entry = createClipboardEntry(item);
                    list.appendChild(entry);
                });
            }

            function setClipboardOpen(nextState){
                if(nextState === clipboardOpen) return;
                clipboardOpen = nextState;
                clipboard.classList.toggle('open', nextState);
                capsule.setAttribute('aria-expanded', nextState ? 'true' : 'false');
                panel.setAttribute('aria-hidden', nextState ? 'false' : 'true');
                if(!nextState){
                    panel.scrollTop = 0;
                }
            }

            async function captureClipboardFiles(files){
                let captured = false;
                const tasks = [];
                Array.from(files || []).forEach(file => {
                    const mime = file.type || '';
                    const item = {
                        id: `${file.name}-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                        name: file.name,
                        size: file.size,
                        type: mime,
                        displayType: mime || 'Файл',
                        file,
                        previewUrl: null,
                        previewKind: null,
                        previewIcon: null,
                        snippet: '',
                        previewPrepared: false,
                        createdAt: Date.now()
                    };
                    clipboardItems.push(item);
                    tasks.push(persistClipboardItem(item));
                    captured = true;
                });
                if(tasks.length){
                    await Promise.allSettled(tasks);
                }
                if(captured){
                    updateClipboardUI();
                }
                return captured;
            }

            const isFileDrag = (event) => {
                const dt = event.dataTransfer;
                if(!dt) return false;
                const types = dt.types ? Array.from(dt.types) : [];
                if(types.includes('Files')) return true;
                if(types.length === 0) return true;
                return dt.files && dt.files.length > 0;
            };

            clipboard.addEventListener('dragenter', (event) => {
                if(!isFileDrag(event)) return;
                event.preventDefault();
                dragDepth += 1;
                clipboard.classList.add('drag-ready');
                if(event.dataTransfer){
                    event.dataTransfer.dropEffect = 'copy';
                }
            });

            clipboard.addEventListener('dragover', (event) => {
                if(!isFileDrag(event)) return;
                event.preventDefault();
                if(event.dataTransfer){
                    event.dataTransfer.dropEffect = 'copy';
                }
            });

            clipboard.addEventListener('dragleave', (event) => {
                if(!isFileDrag(event)) return;
                event.preventDefault();
                dragDepth = Math.max(dragDepth - 1, 0);
                if(dragDepth === 0){
                    clipboard.classList.remove('drag-ready');
                }
            });

            clipboard.addEventListener('drop', async (event) => {
                if(!isFileDrag(event)) return;
                event.preventDefault();
                dragDepth = 0;
                clipboard.classList.remove('drag-ready');
                const files = event.dataTransfer ? event.dataTransfer.files : null;
                if(await captureClipboardFiles(files)){
                    if(!reducedMotion){
                        clipboard.classList.remove('captured');
                        void clipboard.offsetWidth;
                        clipboard.classList.add('captured');
                        setTimeout(() => clipboard.classList.remove('captured'), 600);
                    }
                    setTimeout(() => setClipboardOpen(false), 180);
                }
            });

            capsule.addEventListener('dblclick', async () => {
                await syncClipboardFromDb();
                setClipboardOpen(!clipboardOpen);
            });

            let hoverIntentTimer = null;

            function scheduleAutoClose(){
                if(hoverIntentTimer){
                    clearTimeout(hoverIntentTimer);
                }
                hoverIntentTimer = setTimeout(() => {
                    if(!clipboard.matches(':hover') && clipboardOpen){
                        setClipboardOpen(false);
                    }
                }, 260);
            }

            clipboard.addEventListener('mouseleave', () => {
                if(!clipboardOpen) return;
                scheduleAutoClose();
            });

            clipboard.addEventListener('mouseenter', () => {
                if(hoverIntentTimer){
                    clearTimeout(hoverIntentTimer);
                    hoverIntentTimer = null;
                }
            });

            capsule.addEventListener('keydown', async (event) => {
                if(event.key === 'Enter' || event.key === ' '){
                    event.preventDefault();
                    await syncClipboardFromDb();
                    setClipboardOpen(!clipboardOpen);
                } else if(event.key === 'Escape' && clipboardOpen){
                    setClipboardOpen(false);
                }
            });

            document.addEventListener('click', (event) => {
                if(clipboardOpen && !clipboard.contains(event.target)){
                    setClipboardOpen(false);
                }
            });

            document.addEventListener('keydown', (event) => {
                if(event.key === 'Escape' && clipboardOpen){
                    setClipboardOpen(false);
                }
            });

            window.addEventListener('beforeunload', clearClipboardPreviews);
            window.addEventListener('blur', () => {
                if(clipboardOpen){
                    setClipboardOpen(false);
                }
            });

            await syncClipboardFromDb();
            setClipboardOpen(false);
        })();
    </script>

    <!-- Glare/reflection effect for icon buttons and capsule pill (copied from homepage) -->
    <script>
        (function(){
            if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

            const btns = document.querySelectorAll('.icon-btn');
            btns.forEach(btn=>{
                btn.addEventListener('mousemove', (e)=>{
                    const r = btn.getBoundingClientRect();
                    const x = ((e.clientX - r.left)/r.width)*100;
                    const y = ((e.clientY - r.top)/r.height)*100;
                    btn.style.setProperty('--mx', x + '%');
                    btn.style.setProperty('--my', y + '%');
                    btn.style.setProperty('--ref-opacity', '0.9');
                });
                btn.addEventListener('mouseenter', ()=> btn.style.setProperty('--ref-opacity','0.9'));
                btn.addEventListener('mouseleave', ()=> btn.style.setProperty('--ref-opacity','0'));
            });

            const pills = document.querySelectorAll('.pill');
            pills.forEach(pill=>{
                pill.addEventListener('mousemove', (e)=>{
                    const r = pill.getBoundingClientRect();
                    const x = ((e.clientX - r.left)/r.width)*100;
                    const y = ((e.clientY - r.top)/r.height)*100;
                    pill.style.setProperty('--mx', x + '%');
                    pill.style.setProperty('--my', y + '%');
                    pill.style.setProperty('--pill-ref-opacity', '0.85');
                });
                pill.addEventListener('mouseenter', ()=> pill.style.setProperty('--pill-ref-opacity','0.85'));
                pill.addEventListener('mouseleave', ()=> pill.style.setProperty('--pill-ref-opacity','0'));
            });
        })();
    </script>
</body>
</html>


